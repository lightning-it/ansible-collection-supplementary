---
name: Ansible Lint and Release
"on":
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  # Default to Forgejo instance for container registry
  CONTAINER_REGISTRY: ${{ vars.CONTAINER_REGISTRY || github.server_url }}

jobs:
  lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    container:
      image: ${{ vars.ANSIBLE_LINT_IMAGE }}
      credentials:
        username: git
        password: ${{ secrets.GITEA_TOKEN }}
    steps:
      - name: Checkout code
        uses: https://github.com/actions/checkout@v6

      - name: Run ansible-lint
        run: |
          echo "Running ansible-lint..."
          ansible-lint --version
          ansible-lint --profile production -v

          # Optional: Run with custom config
          if [ -f .ansible-lint.yml ]; then
            echo "Using custom .ansible-lint.yml"
            ansible-lint -c .ansible-lint.yml --profile production
          fi

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: lint
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      needs.lint.result == 'success'
    steps:
      - name: Setup Custom CA Certificate
        run: |
          if [ -n "${{ secrets.CUSTOM_CA_CERT }}" ]; then
            echo "Installing custom CA certificate..."

            # 1. CA-Zertifikat im System speichern
            echo "${{ secrets.CUSTOM_CA_CERT }}" | sudo tee /usr/local/share/ca-certificates/custom-ca.crt > /dev/null

            # 2. CA-Zertifikat für curl/wget
            echo "${{ secrets.CUSTOM_CA_CERT }}" | sudo tee /etc/ssl/certs/custom-ca.pem > /dev/null

            # 3. CA-Zertifikat für OpenSSL
            echo "${{ secrets.CUSTOM_CA_CERT }}" | sudo tee -a /etc/ssl/certs/ca-certificates.crt > /dev/null

            # 4. System Zertifikate aktualisieren
            sudo update-ca-certificates

            # 5. Git konfigurieren
            git config --global http.sslCAInfo /etc/ssl/certs/ca-certificates.crt
            git config --global http.sslVerify true

            # 6. Node.js/npm Umgebungsvariablen setzen
            echo "NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt" >> $GITHUB_ENV
            echo "NPM_CONFIG_STRICT_SSL=false" >> $GITHUB_ENV

            # 7. Für curl und wget
            echo "CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt" >> $GITHUB_ENV

            echo "Custom CA certificate installed successfully"
          else
            echo "No custom CA certificate provided"
          fi

      - name: Checkout code
        uses: https://github.com/actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITEA_TOKEN }}

      - name: Extract instance domain
        id: extract-domain
        run: |
          INSTANCE_URL="${{ github.server_url }}"
          INSTANCE_DOMAIN="${INSTANCE_URL#https://}"
          INSTANCE_DOMAIN="${INSTANCE_DOMAIN#http://}"
          echo "instance_domain=${INSTANCE_DOMAIN}" >> $GITHUB_OUTPUT

      - name: Generate dynamic .releaserc.json
        id: generate-config
        run: |
          # Create a dynamic .releaserc.json from your YAML config
          cat > .releaserc.json << EOF
          {
            "branches": ["main"],
            "plugins": [
              "@semantic-release/commit-analyzer",
              "@semantic-release/release-notes-generator",
              "@semantic-release/changelog",
              ["@semantic-release/git", {
                "assets": ["CHANGELOG.md"]
              }],
              ["@saithodev/semantic-release-gitea", {
                "giteaUrl": "${{ github.server_url }}",
                "assets": [{"path": "CHANGELOG.md"}]
              }]
            ]
          }
          EOF

          echo "Generated .releaserc.json:"
          cat .releaserc.json

      - name: Run Semantic Release
        uses: https://github.com/cycjimmy/semantic-release-action@v4
        env:
          GITEA_URL: ${{ github.server_url }}
          GITEA_TOKEN: ${{ secrets.GITEA_TOKEN }}
          GIT_AUTHOR_NAME: ${{ github.actor }}
          GIT_AUTHOR_EMAIL: ${{ github.actor }}@users.noreply.${{ steps.extract-domain.outputs.instance_domain }}
        with:
          extra_plugins: |
            @semantic-release/changelog
            @semantic-release/git
            @saithodev/semantic-release-gitea
          dry_run: false
          branch: main
