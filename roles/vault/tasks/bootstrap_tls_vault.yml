---
- name: Ensure directories exist for Vault certs and data
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ vau_data_dir }}"
    - "{{ vau_cert_dir }}"
    - "{{ vau_config_dir }}"
  tags:
    - init

- name: Try to read existing certificate from Vault
  delegate_to: localhost
  community.hashi_vault.vault_kv2_get:
    url: "{{ vau_vault_address }}"
    engine_mount_point: "{{ vau_engine_mount_point }}"
    auth_method: "{{ vau_hashi_vault_auth_method }}"
    role_id: "{{ ansible_hashi_vault_role_id | default('') }}"
    secret_id: "{{ ansible_hashi_vault_secret_id | default('') }}"
    validate_certs: "{{ vau_vault_validate_certs }}"
    path: "{{ inventory_hostname }}/vault/certificate"
  register: existing_cert
  failed_when: false
  no_log: true
  tags:
    - vault_pki

- name: Create tmp selfsigned certificate
  when: existing_cert.data is not defined
  block:
    - name: Create private key (RSA, 4096 bits)
      community.crypto.openssl_privatekey:
        path: "{{ vau_cert_dir }}/vault.key"
      tags:
        - init

    - name: Create certificate signing request (CSR) for self-signed certificate
      community.crypto.openssl_csr_pipe:
        privatekey_path: "{{ vau_cert_dir }}/vault.key"
        common_name: "{{ inventory_hostname }}"
        organization_name: Ansible, Inc.
        subject_alt_name:
          - "IP:127.0.0.1"
          - "DNS:{{ inventory_hostname }}"
          - "DNS:localhost"
          - "DNS:vault"
      register: csr
      tags:
        - init

    - name: Generate Vault server certificate signed by self-signed CA
      community.crypto.x509_certificate:
        path: "{{ vau_cert_dir }}/vault.crt"
        privatekey_path: "{{ vau_cert_dir }}/vault.key"
        csr_content: "{{ csr.csr }}"
        provider: selfsigned
      tags:
        - init

    - name: Set proper ownership and permissions for Vault private key
      ansible.builtin.file:
        path: "{{ vau_cert_dir }}/vault.key"
        mode: "0644"
      tags:
        - init
