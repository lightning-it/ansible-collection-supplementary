---
- name: Ensure data and cert directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ vault_run_as_user | default(100) }}"
    group: "{{ vault_run_as_group | default(1000) }}"
    mode: '0755'
  loop:
    - "{{ vault_data_dir | dirname }}"
    - "{{ vault_cert_dir }}"
    - "{{ vault_config_dir }}"
    - "{{ vault_pod_manifest_path | dirname }}"
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment

- name: Ensure Vault data subdirectories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ vault_run_as_user | default(100) }}"
    group: "{{ vault_run_as_group | default(1000) }}"
    mode: '0700'
  loop:
    - "{{ vault_data_dir }}/core"
    - "{{ vault_data_dir }}/sys"
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment

- name: Ensure Vault data directory permissions
  ansible.builtin.file:
    path: "{{ vault_data_dir }}"
    state: directory
    owner: "{{ vault_run_as_user | default(100) }}"
    group: "{{ vault_run_as_group | default(1000) }}"
    mode: '0700'
  tags:
    - deployment

- name: Ensure Vault data directory ownership
  ansible.builtin.file:
    path: "{{ vault_data_dir }}"
    state: directory
    owner: "{{ vault_run_as_user | default(100) }}"
    group: "{{ vault_run_as_group | default(1000) }}"
    recurse: true
  tags:
    - deployment

- name: Detect SELinux status
  ansible.builtin.command: getenforce
  register: selinux_status
  changed_when: false
  failed_when: false
  when: ansible_distribution in ['RedHat', 'CentOS']

- name: Set Vault container name
  ansible.builtin.set_fact:
    vault_container_name: "{{ vault_pod_name }}-vault"
  when: vault_pod_name is defined

- name: Check SELinux context
  ansible.builtin.command: "stat -c %C {{ item }}"
  loop:
    - "{{ vault_data_dir | dirname }}"
    - "{{ vault_data_dir }}"
    - "{{ vault_cert_dir }}"
    - "{{ vault_config_dir }}"
  register: selinux_contexts
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - ansible_distribution in ['RedHat', 'CentOS']
    - selinux_status.stdout is defined
    - selinux_status.stdout != 'Disabled'

- name: Apply SELinux context
  ansible.builtin.command: "chcon -Rt container_file_t {{ vault_data_dir | dirname }}"
  register: selinux_cmd
  changed_when: selinux_cmd.rc == 0
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment
  when:
    - ansible_distribution in ['RedHat', 'CentOS']
    - selinux_status.stdout is defined
    - selinux_status.stdout != 'Disabled'
    - selinux_contexts is defined
    - selinux_contexts.results is defined
    - >
      (selinux_contexts.results
       | map(attribute='stdout')
       | select('search', 'container_file_t')
       | list
       | length)
      <
      (selinux_contexts.results | length)

- name: Render Vault Pod manifest
  ansible.builtin.template:
    src: vault-pod.yml.j2
    dest: "{{ vault_pod_manifest_path }}"
    mode: '0644'
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment

- name: Render Vault config
  ansible.builtin.template:
    src: vau-config.hcl.j2
    dest: "{{ vault_config_dir }}/vault.hcl"
    mode: '0644'
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
  tags:
    - deployment

- name: Read Vault container running state
  ansible.builtin.command: "podman inspect {{ vault_container_name }} --format {{ '{{.State.Running}}' }}"
  register: vault_container_running
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - vault_container_name is defined

- name: Read Vault data dir ownership inside container
  ansible.builtin.command: >-
    podman exec --user 0 {{ vault_container_name }}
    stat -c '%u:%g %a' /vault/data
  register: vault_data_stat
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - vault_container_running.stdout is defined
    - vault_container_running.stdout | trim == 'true'

- name: Fix Vault data dir ownership inside container
  ansible.builtin.command: >-
    podman exec --user 0 {{ vault_container_name }} sh -c
    'mkdir -p /vault/data/core /vault/data/sys
    && chown -R {{ vault_run_as_user | default(100) }}:{{ vault_run_as_group | default(1000) }} /vault/data
    && chmod 0700 /vault/data /vault/data/core /vault/data/sys'
  register: vault_data_fix
  changed_when: vault_data_fix.rc == 0
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment
  when:
    - vault_container_running.stdout is defined
    - vault_container_running.stdout | trim == 'true'
    - vault_data_stat.stdout is defined
    - vault_data_stat.stdout | trim
      != (vault_run_as_user | default(100) | string)
         ~ ':' ~ (vault_run_as_group | default(1000) | string)
         ~ ' 700'

- name: Read Vault container mount label
  ansible.builtin.command: "podman inspect {{ vault_container_name }} --format {{ '{{.MountLabel}}' }}"
  register: vault_mount_label
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - ansible_distribution in ['RedHat', 'CentOS']
    - selinux_status.stdout is defined
    - selinux_status.stdout != 'Disabled'
    - vault_container_name is defined
    - not vault_manage_systemd | default(false) | bool

- name: Read Vault container uid map (inspect)
  ansible.builtin.command: >-
    podman inspect {{ vault_container_name }}
    --format {{ '{{range .HostConfig.IDMappings.UidMap}}{{println .ContainerID .HostID .Size}}{{end}}' }}
  register: vault_uid_map_inspect
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - vault_container_name is defined

- name: Read Vault container gid map (inspect)
  ansible.builtin.command: >-
    podman inspect {{ vault_container_name }}
    --format {{ '{{range .HostConfig.IDMappings.GidMap}}{{println .ContainerID .HostID .Size}}{{end}}' }}
  register: vault_gid_map_inspect
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - vault_container_name is defined

- name: Set Vault container uid/gid map lines (inspect)
  ansible.builtin.set_fact:
    vault_uid_map_lines: "{{ vault_uid_map_inspect.stdout_lines | default([]) }}"
    vault_gid_map_lines: "{{ vault_gid_map_inspect.stdout_lines | default([]) }}"
  tags:
    - deployment
  when:
    - vault_uid_map_inspect is defined
    - vault_gid_map_inspect is defined
    - vault_uid_map_inspect.rc | default(1) == 0
    - vault_gid_map_inspect.rc | default(1) == 0
    - vault_uid_map_inspect.stdout_lines is defined
    - vault_uid_map_inspect.stdout_lines | length > 0
    - vault_gid_map_inspect.stdout_lines is defined
    - vault_gid_map_inspect.stdout_lines | length > 0

- name: Read Vault container PID
  ansible.builtin.command: "podman inspect {{ vault_container_name }} --format {{ '{{.State.Pid}}' }}"
  register: vault_container_pid
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - vault_container_name is defined
    - (vault_uid_map_lines | default([]) | length == 0)
      or (vault_gid_map_lines | default([]) | length == 0)

- name: Read Vault container uid/gid maps (proc)
  ansible.builtin.command: "cat /proc/{{ vault_container_pid.stdout | trim }}/{{ item }}"
  register: vault_container_id_maps
  changed_when: false
  failed_when: false
  tags:
    - deployment
  loop:
    - uid_map
    - gid_map
  when:
    - vault_container_pid.stdout is defined
    - vault_container_pid.stdout | trim | length > 0
    - vault_container_pid.stdout | trim | int > 0
    - (vault_uid_map_lines | default([]) | length == 0)
      or (vault_gid_map_lines | default([]) | length == 0)

- name: Set Vault container uid/gid map lines (proc)
  ansible.builtin.set_fact:
    vault_uid_map_lines: >-
      {{
        (vault_uid_map_lines | default([]) | length > 0)
        | ternary(
            vault_uid_map_lines,
            vault_container_id_maps.results[0].stdout_lines | default([])
          )
      }}
    vault_gid_map_lines: >-
      {{
        (vault_gid_map_lines | default([]) | length > 0)
        | ternary(
            vault_gid_map_lines,
            vault_container_id_maps.results[1].stdout_lines | default([])
          )
      }}
  tags:
    - deployment
  when:
    - vault_container_id_maps is defined
    - vault_container_id_maps.results is defined
    - vault_container_id_maps.results | length == 2
    - vault_container_id_maps.results[0].stdout_lines is defined
    - vault_container_id_maps.results[1].stdout_lines is defined
    - (vault_uid_map_lines | default([]) | length == 0)
      or (vault_gid_map_lines | default([]) | length == 0)

- name: Select Vault uid/gid map lines for run-as user/group
  ansible.builtin.set_fact:
    vault_uid_map_line: >-
      {% set target = vault_run_as_user | default(100) | int %}
      {% set ns = namespace(match='') %}
      {% for line in vault_uid_map_lines %}
      {%   set parts = line.split() %}
      {%   if parts | length >= 3 %}
      {%     set start = parts[0] | int %}
      {%     set size = parts[2] | int %}
      {%     if target >= start and target < start + size %}
      {%       set ns.match = line %}
      {%     endif %}
      {%   endif %}
      {% endfor %}
      {{ ns.match }}
    vault_gid_map_line: >-
      {% set target = vault_run_as_group | default(1000) | int %}
      {% set ns = namespace(match='') %}
      {% for line in vault_gid_map_lines %}
      {%   set parts = line.split() %}
      {%   if parts | length >= 3 %}
      {%     set start = parts[0] | int %}
      {%     set size = parts[2] | int %}
      {%     if target >= start and target < start + size %}
      {%       set ns.match = line %}
      {%     endif %}
      {%   endif %}
      {% endfor %}
      {{ ns.match }}
  tags:
    - deployment
  when:
    - vault_uid_map_lines is defined
    - vault_uid_map_lines | length > 0
    - vault_gid_map_lines is defined
    - vault_gid_map_lines | length > 0

- name: Parse Vault container uid/gid map ranges (selected)
  ansible.builtin.set_fact:
    vault_uid_map_parts: "{{ vault_uid_map_line.split() }}"
    vault_gid_map_parts: "{{ vault_gid_map_line.split() }}"
  tags:
    - deployment
  when:
    - vault_uid_map_parts is not defined
    - vault_gid_map_parts is not defined
    - vault_uid_map_line is defined
    - vault_uid_map_line | trim | length > 0
    - vault_gid_map_line is defined
    - vault_gid_map_line | trim | length > 0

- name: Calculate Vault host uid/gid from container map
  ansible.builtin.set_fact:
    vault_host_uid: >-
      {{
        (vault_uid_map_parts[1] | int)
        + ((vault_run_as_user | default(100) | int) - (vault_uid_map_parts[0] | int))
      }}
    vault_host_gid: >-
      {{
        (vault_gid_map_parts[1] | int)
        + ((vault_run_as_group | default(1000) | int) - (vault_gid_map_parts[0] | int))
      }}
  tags:
    - deployment
  when:
    - vault_uid_map_parts is defined
    - vault_gid_map_parts is defined
    - vault_uid_map_parts | length > 2
    - vault_gid_map_parts | length > 2
    - (vault_run_as_user | default(100) | int) >= (vault_uid_map_parts[0] | int)
    - (vault_run_as_user | default(100) | int) < ((vault_uid_map_parts[0] | int) + (vault_uid_map_parts[2] | int))
    - (vault_run_as_group | default(1000) | int) >= (vault_gid_map_parts[0] | int)
    - (vault_run_as_group | default(1000) | int) < ((vault_gid_map_parts[0] | int) + (vault_gid_map_parts[2] | int))

- name: Ensure Vault data dir ownership matches container mapping
  ansible.builtin.file:
    path: "{{ vault_data_dir }}"
    state: directory
    owner: "{{ vault_host_uid }}"
    group: "{{ vault_host_gid }}"
    recurse: true
  tags:
    - deployment
  when:
    - vault_host_uid is defined
    - vault_host_gid is defined

- name: Parse Vault container mount label
  ansible.builtin.set_fact:
    vault_mount_label_parts: "{{ (vault_mount_label.stdout | trim).split(':') }}"
  tags:
    - deployment
  when:
    - vault_mount_label.stdout is defined
    - vault_mount_label.stdout | trim | length > 0
    - not vault_manage_systemd | default(false) | bool

- name: Set Vault container mount label pieces
  ansible.builtin.set_fact:
    vault_mount_label_type: "{{ vault_mount_label_parts[2] }}"
    vault_mount_label_level: "{{ vault_mount_label_parts[3:] | join(':') }}"
  tags:
    - deployment
  when:
    - vault_mount_label_parts is defined
    - vault_mount_label_parts | length > 3
    - not vault_manage_systemd | default(false) | bool

- name: Check Vault data dir label for mount context
  ansible.builtin.command: "stat -c %C {{ vault_data_dir | dirname }}"
  register: vault_mount_label_current
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - ansible_distribution in ['RedHat', 'CentOS']
    - selinux_status.stdout is defined
    - selinux_status.stdout != 'Disabled'
    - vault_mount_label.stdout is defined
    - vault_mount_label.stdout | trim | length > 0
    - not vault_manage_systemd | default(false) | bool

- name: Parse current mount label
  ansible.builtin.set_fact:
    vault_mount_label_current_parts: "{{ (vault_mount_label_current.stdout | trim).split(':') }}"
  tags:
    - deployment
  when:
    - vault_mount_label_current.stdout is defined
    - vault_mount_label_current.stdout | trim | length > 0
    - not vault_manage_systemd | default(false) | bool

- name: Set current mount label pieces
  ansible.builtin.set_fact:
    vault_mount_label_current_type: "{{ vault_mount_label_current_parts[2] }}"
    vault_mount_label_current_level: "{{ vault_mount_label_current_parts[3:] | join(':') }}"
  tags:
    - deployment
  when:
    - vault_mount_label_current_parts is defined
    - vault_mount_label_current_parts | length > 3
    - not vault_manage_systemd | default(false) | bool

- name: Apply Vault mount label to data dir
  ansible.builtin.command: >-
    chcon -Rt {{ vault_mount_label_type }}
    -l {{ vault_mount_label_level }}
    {{ vault_data_dir | dirname }}
  register: vault_mount_label_apply
  changed_when: vault_mount_label_apply.rc == 0
  tags:
    - deployment
  when:
    - ansible_distribution in ['RedHat', 'CentOS']
    - selinux_status.stdout is defined
    - selinux_status.stdout != 'Disabled'
    - vault_mount_label_type is defined
    - vault_mount_label_level is defined
    - vault_mount_label_level | length > 0
    - vault_mount_label_current_type is defined
    - vault_mount_label_current_level is defined
    - not vault_manage_systemd | default(false) | bool
    - >
      vault_mount_label_current_type != vault_mount_label_type
      or vault_mount_label_current_level != vault_mount_label_level
