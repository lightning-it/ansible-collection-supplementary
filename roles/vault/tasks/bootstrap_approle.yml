---
- name: Load init vars when missing
  delegate_to: localhost
  ansible.builtin.include_vars:
    file: "{{ vault_init_path }}/vault-init.yml"
  when: vault_unseal_keys_encrypted is not defined
  no_log: true

- name: Parse init data for root token
  ansible.builtin.set_fact:
    vault_init_data: "{{ vault_unseal_payload }}"
  no_log: true
  vars:
    vault_unseal_payload: >-
      {{
        vault_unseal_keys_encrypted
        if vault_unseal_keys_encrypted is mapping
        else (vault_unseal_keys_encrypted | string | from_json)
      }}

- name: Set root token for bootstrapping
  ansible.builtin.set_fact:
    vault_root_token: "{{ vault_init_data.root_token }}"
  no_log: true

- name: Build default AppRole policy
  ansible.builtin.set_fact:
    vault_approle_policy: "{{ vault_approle_policy | default(_vault_approle_policy, true) }}"
  vars:
    _vault_approle_policy: |-
      path "{{ vault_engine_mount_point }}/data/{{ inventory_hostname }}/vault/certificate" {
        capabilities = ["read", "create", "update"]
      }
      path "{{ vault_engine_mount_point }}/metadata/{{ inventory_hostname }}/vault/certificate" {
        capabilities = ["read"]
      }
      path "{{ vault_vault_pki_path }}/{{ vault_vault_pki_role }}" {
        capabilities = ["read", "create", "update"]
      }

- name: Normalize AppRole policy names
  ansible.builtin.set_fact:
    vault_approle_policy_names: >-
      {{
        (vault_approle_secrets[0].token_policy
          if (vault_approle_secrets | length > 0
              and vault_approle_secrets[0].token_policy is defined)
          else vault_approle_policy_name)
      }}

- name: Ensure AppRole policy name list
  ansible.builtin.set_fact:
    vault_approle_policy_names: >-
      {{
        [vault_approle_policy_names]
        if vault_approle_policy_names is string
        else vault_approle_policy_names
      }}
    vault_approle_policy_name: >-
      {{
        (vault_approle_policy_names | first)
        if (vault_approle_policy_names | length > 0)
        else vault_approle_policy_name
      }}

- name: Select AppRole credential storage path
  ansible.builtin.set_fact:
    vault_approle_kv_mount: >-
      {{
        (vault_approle_secrets[0].kv_mount
          if (vault_approle_secrets | length > 0
              and vault_approle_secrets[0].kv_mount is defined)
          else vault_engine_mount_point)
      }}
    vault_approle_kv_path: >-
      {{
        (vault_approle_secrets[0].credential_path
          if (vault_approle_secrets | length > 0
              and vault_approle_secrets[0].credential_path is defined)
          else (inventory_hostname ~ '/vault/approle'))
      }}

- name: Read Vault mounts
  delegate_to: "{{ vault_api_delegate_to }}"
  community.hashi_vault.vault_read:
    url: "{{ vault_vault_address }}"
    token: "{{ vault_root_token }}"
    validate_certs: "{{ vault_vault_validate_certs }}"
    path: "sys/mounts"
  register: vault_mounts
  no_log: true

- name: Detect KV mount presence
  ansible.builtin.set_fact:
    vault_approle_kv_mount_present: >-
      {{
        (vault_mounts.data is defined)
        and ((vault_approle_kv_mount | regex_replace('/$', '') ~ '/') in vault_mounts.data)
      }}
  # no_log: true

- name: Ensure KV v2 mount exists for AppRole credentials
  delegate_to: "{{ vault_api_delegate_to }}"
  community.hashi_vault.vault_write:
    url: "{{ vault_vault_address }}"
    token: "{{ vault_root_token }}"
    validate_certs: "{{ vault_vault_validate_certs }}"
    path: "sys/mounts/{{ vault_approle_kv_mount | regex_replace('/$', '') }}"
    data:
      type: "kv"
      options:
        version: "2"
  when: not vault_approle_kv_mount_present | bool

- name: Read Vault auth methods
  delegate_to: "{{ vault_api_delegate_to }}"
  community.hashi_vault.vault_read:
    url: "{{ vault_vault_address }}"
    token: "{{ vault_root_token }}"
    validate_certs: "{{ vault_vault_validate_certs }}"
    path: "sys/auth"
  register: vault_auth_methods
  no_log: true

- name: Detect AppRole auth status
  ansible.builtin.set_fact:
    vault_approle_enabled: "{{ 'approle/' in (vault_auth_methods.data | default({})) }}"

- name: Enable AppRole auth method when missing
  delegate_to: "{{ vault_api_delegate_to }}"
  community.hashi_vault.vault_write:
    url: "{{ vault_vault_address }}"
    token: "{{ vault_root_token }}"
    validate_certs: "{{ vault_vault_validate_certs }}"
    path: "sys/auth/approle"
    data:
      type: "approle"
  when: not vault_approle_enabled | bool

- name: Ensure AppRole policy exists
  delegate_to: "{{ vault_api_delegate_to }}"
  community.hashi_vault.vault_write:
    url: "{{ vault_vault_address }}"
    token: "{{ vault_root_token }}"
    validate_certs: "{{ vault_vault_validate_certs }}"
    path: "sys/policies/acl/{{ vault_approle_policy_name }}"
    data:
      policy: "{{ vault_approle_policy }}"
  changed_when: false

- name: Ensure AppRole exists
  delegate_to: "{{ vault_api_delegate_to }}"
  community.hashi_vault.vault_write:
    url: "{{ vault_vault_address }}"
    token: "{{ vault_root_token }}"
    validate_certs: "{{ vault_vault_validate_certs }}"
    path: "auth/approle/role/{{ vault_approle_role_name }}"
    data:
      token_policies: "{{ vault_approle_policy_names }}"
      token_ttl: "{{ vault_approle_token_ttl | default(omit, true) }}"
      token_max_ttl: "{{ vault_approle_token_max_ttl | default(omit, true) }}"
  changed_when: false

- name: Read AppRole role_id
  delegate_to: "{{ vault_api_delegate_to }}"
  community.hashi_vault.vault_read:
    url: "{{ vault_vault_address }}"
    token: "{{ vault_root_token }}"
    validate_certs: "{{ vault_vault_validate_certs }}"
    path: "auth/approle/role/{{ vault_approle_role_name }}/role-id"
  register: vault_approle_role_id
  no_log: true

- name: Normalize AppRole role_id
  ansible.builtin.set_fact:
    vault_approle_read_role_id: >-
      {{
        (vault_approle_role_id.data.role_id
          if (vault_approle_role_id.data is defined
              and vault_approle_role_id.data.role_id is defined)
          else
            (vault_approle_role_id.data.data.role_id
              if (vault_approle_role_id.data is defined
                  and vault_approle_role_id.data.data is defined
                  and vault_approle_role_id.data.data.role_id is defined)
              else ''))
      }}
  no_log: true

- name: Read stored AppRole credentials
  delegate_to: "{{ vault_api_delegate_to }}"
  community.hashi_vault.vault_kv2_get:
    url: "{{ vault_vault_address }}"
    token: "{{ vault_root_token }}"
    validate_certs: "{{ vault_vault_validate_certs }}"
    engine_mount_point: "{{ vault_approle_kv_mount }}"
    path: "{{ vault_approle_kv_path }}"
  register: vault_approle_kv
  failed_when: false
  no_log: true

- name: Extract stored AppRole secret_id
  ansible.builtin.set_fact:
    vault_approle_kv_role_id: >-
      {{
        (vault_approle_kv.data.data.role_id | default(''))
        if vault_approle_kv.data is defined
        else ''
      }}
    vault_approle_kv_secret_id: >-
      {{
        (vault_approle_kv.data.data.secret_id | default(''))
        if vault_approle_kv.data is defined
        else ''
      }}
  no_log: true

- name: Generate AppRole secret_id
  delegate_to: "{{ vault_api_delegate_to }}"
  community.hashi_vault.vault_write:
    url: "{{ vault_vault_address }}"
    token: "{{ vault_root_token }}"
    validate_certs: "{{ vault_vault_validate_certs }}"
    path: "auth/approle/role/{{ vault_approle_role_name }}/secret-id"
  register: vault_approle_secret
  no_log: true
  when: vault_approle_kv_secret_id | length == 0

- name: Set AppRole credentials for current run
  ansible.builtin.set_fact:
    ansible_hashi_vault_role_id: >-
      {{
        vault_approle_kv_role_id
        if vault_approle_kv_role_id | length > 0
        else vault_approle_read_role_id
      }}
    ansible_hashi_vault_secret_id: >-
      {{
        vault_approle_kv_secret_id
        if vault_approle_kv_secret_id | length > 0
        else
          (vault_approle_secret.data.secret_id
            if (vault_approle_secret.data is defined
                and vault_approle_secret.data.secret_id is defined)
            else
              (vault_approle_secret.data.data.secret_id
                if (vault_approle_secret.data is defined
                    and vault_approle_secret.data.data is defined
                    and vault_approle_secret.data.data.secret_id is defined)
                else ''))
      }}
  no_log: true

- name: Assert AppRole credentials resolved
  ansible.builtin.assert:
    that:
      - ansible_hashi_vault_role_id | length > 0
      - ansible_hashi_vault_secret_id | length > 0
    fail_msg: >-
      AppRole credentials could not be resolved from Vault; check AppRole
      permissions and root token access to auth/approle/role/{{ vault_approle_role_name }}.

- name: Store AppRole credentials for reuse
  delegate_to: "{{ vault_api_delegate_to }}"
  community.hashi_vault.vault_kv2_write:
    url: "{{ vault_vault_address }}"
    token: "{{ vault_root_token }}"
    validate_certs: "{{ vault_vault_validate_certs }}"
    engine_mount_point: "{{ vault_approle_kv_mount }}"
    path: "{{ vault_approle_kv_path }}"
    data:
      role_id: "{{ ansible_hashi_vault_role_id }}"
      secret_id: "{{ ansible_hashi_vault_secret_id }}"
  # no_log: true
  when:
    - vault_approle_kv_secret_id | length == 0
      or vault_approle_kv_role_id != ansible_hashi_vault_role_id
