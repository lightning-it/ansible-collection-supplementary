---
- name: Recreate vault pod
  ansible.builtin.command: podman pod rm -f vault
  register: rm_pod
  failed_when: rm_pod.rc not in [0,125]
  changed_when: "'deleted' in rm_pod.stdout"
  ignore_errors: true

- name: Run vault pod
  ansible.builtin.command:
    cmd: "podman kube play {{ vault_pod_manifest_path }}"
  register: pod_start
  changed_when: "'created' in pod_start.stdout or 'configured' in pod_start.stdout"

- name: Reload vault_unseal_keys_encrypted vars
  ansible.builtin.include_vars:
    file: "{{ vault_init_path }}/vault-init.yml"

- name: Write root_token to file
  delegate_to: localhost
  ansible.builtin.copy:
    content: "{{ vault_unseal_payload.root_token }}"
    dest: "~/.vault-token"
    mode: "0600"
  no_log: true
  vars:
    vault_unseal_payload: >-
      {{
        vault_unseal_keys_encrypted
        if vault_unseal_keys_encrypted is mapping
        else (vault_unseal_keys_encrypted | string | from_json)
      }}
  when: vault_unseal_keys_encrypted is defined
