---
- name: Check ESXi API with configured password
  community.vmware.vmware_about_info:
    hostname: "{{ manage_esxi_connection_hostname }}"
    username: "{{ manage_esxi_username }}"
    password: "{{ manage_esxi_password }}"
    validate_certs: "{{ manage_esxi_validate_certs }}"
  delegate_to: localhost
  register: esxi_login_current
  failed_when: false

- name: Check if bootstrap is necessary (initial password)
  community.vmware.vmware_about_info:
    hostname: "{{ manage_esxi_connection_hostname }}"
    username: "{{ manage_esxi_username }}"
    password: "{{ manage_esxi_initial_password }}"
    validate_certs: "{{ manage_esxi_validate_certs }}"
  delegate_to: localhost
  register: esxi_login_initial
  failed_when: false
  when:
    - esxi_login_current is failed

- name: Track current and initial authentication status
  ansible.builtin.set_fact:
    manage_esxi_current_auth_ok: "{{ esxi_login_current is not failed }}"
    manage_esxi_initial_auth_ok: "{{ esxi_login_initial is defined and esxi_login_initial is not failed }}"

- name: Set bootstrap variable when only initial password works
  ansible.builtin.set_fact:
    need_bootstrap: true
  when:
    - not manage_esxi_current_auth_ok
    - manage_esxi_initial_auth_ok

- name: Warn when authentication fails for both passwords
  ansible.builtin.debug:
    msg: "Skipping bootstrap: cannot authenticate with either current or initial ESXi password."
  when:
    - not manage_esxi_current_auth_ok
    - not manage_esxi_initial_auth_ok

- name: Update the default root user password (direct connection to ESXi host)
  community.vmware.vmware_host_user_manager:
    hostname: "{{ manage_esxi_connection_hostname }}"
    username: "{{ manage_esxi_username }}"
    password: "{{ manage_esxi_initial_password }}"
    validate_certs: "{{ manage_esxi_validate_certs }}"
    esxi_hostname: "{{ manage_esxi_hostname }}"
    user_name: "{{ manage_esxi_username }}"
    user_description: "default root user"
    user_password: "{{ manage_esxi_password }}"
    override_user_password: true
    state: present
  delegate_to: localhost
  when: need_bootstrap | default(false)

- name: Configure DNS for ESXi host (direct connection to ESXi host)
  community.vmware.vmware_host_dns:
    hostname: "{{ manage_esxi_connection_hostname }}"
    username: "{{ manage_esxi_username }}"
    password: "{{ manage_esxi_password }}"
    validate_certs: "{{ manage_esxi_validate_certs }}"
    type: static
    host_name: "{{ manage_esxi_hostname.split('.')[0] }}"
    domain: "{{ manage_esxi_domain_name }}"
    dns_servers: "{{ manage_esxi_dns_servers }}"
    search_domains: "{{ manage_esxi_search_domains }}"
  delegate_to: localhost

- name: Add Management vmkernel port (direct connection to ESXi host)
  community.vmware.vmware_vmkernel:
    hostname: "{{ manage_esxi_connection_hostname }}"
    username: "{{ manage_esxi_username }}"
    password: "{{ manage_esxi_password }}"
    validate_certs: "{{ manage_esxi_validate_certs }}"
    esxi_hostname: "{{ manage_esxi_hostname }}"
    vswitch_name: "{{ manage_esxi_mgmt_vmkernel.vswitch_name }}"
    portgroup_name: "{{ manage_esxi_mgmt_vmkernel.portgroup_name }}"
    network: "{{ manage_esxi_mgmt_vmkernel.network | default(omit) }}"
    state: "{{ manage_esxi_mgmt_vmkernel.state | default('present') }}"
    enable_mgmt: "{{ manage_esxi_mgmt_vmkernel.enable_mgmt | default(true) }}"
  delegate_to: localhost
  when:
    - manage_esxi_mgmt_vmkernel is defined
    - manage_esxi_mgmt_vmkernel.portgroup_name is defined
    - manage_esxi_mgmt_vmkernel.portgroup_name | length > 0
    - manage_esxi_mgmt_vmkernel.vswitch_name is defined
    - manage_esxi_mgmt_vmkernel.vswitch_name | length > 0
