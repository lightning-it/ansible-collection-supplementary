---
- name: Normalize manage_esxi_default_users to a list
  ansible.builtin.set_fact:
    manage_esxi_default_users_effective: >-
      {{
        (
          manage_esxi_default_users | default({})
        ) is mapping
          | ternary(
              manage_esxi_default_users | default({}) | dict2items,
              manage_esxi_default_users | default([])
            )
      }}
  tags:
    - always

- name: Ensure ESXi host password is set for user management
  ansible.builtin.set_fact:
    manage_esxi_host_password: "{{ manage_esxi_password | default(manage_esxi_host_password, true) }}"
  when: (manage_esxi_host_password | default('') | length) == 0
  no_log: true
  tags:
    - always

- name: Manage local users on ESXi
  community.vmware.vmware_host_user_manager:
    hostname: "{{ manage_esxi_connection_hostname }}"
    username: "{{ manage_esxi_username }}"
    password: "{{ manage_esxi_host_password | default(manage_esxi_password, true) }}"
    validate_certs: "{{ manage_esxi_validate_certs }}"
    esxi_hostname: "{{ manage_esxi_hostname }}"
    user_name: "{{ item.value.user }}"
    user_description: "{{ item.value.description | default('') }}"
    user_password: "{{ item.value.password }}"
    shell_access: "{{ item.value.shell_access | default(omit) }}"
    role_name: "{{ item.value.role_name | default(omit) }}"
    state: "{{ item.value.state | default('present') }}"
  loop: "{{ manage_esxi_default_users_effective }}"
  delegate_to: localhost
  when:
    - manage_esxi_default_users_effective is defined
    - manage_esxi_default_users_effective | length > 0
  tags:
    - manage_esxi_users
