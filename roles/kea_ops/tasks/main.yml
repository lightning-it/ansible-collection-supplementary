---
- name: Ensure required Kea vars are defined
  ansible.builtin.import_role:
    name: kea_deploy
    tasks_from: assert
  tags: always

- name: Ensure kea_ops_action is valid
  ansible.builtin.assert:
    that:
      - kea_ops_action in ['none', 'restart', 'reload', 'status', 'upgrade']
    fail_msg: "kea_ops_action must be one of: none, restart, reload, status, upgrade."
  tags: always

- name: Restart Kea service
  when: kea_ops_action == 'restart'
  tags:
    - ops
    - restart
  block:
    - name: Restart Kea systemd unit
      ansible.builtin.systemd:
        name: "{{ kea_deploy_systemd_unit_name }}"
        state: restarted
      when: kea_deploy_manage_systemd | bool

    - name: Restart Kea pod (non-systemd)
      ansible.builtin.command: "podman pod restart {{ kea_deploy_pod_name }}"
      register: kea_deploy_pod_restart
      changed_when: kea_deploy_pod_restart.rc == 0
      when: not kea_deploy_manage_systemd | bool

    - name: Validate Kea after restart
      ansible.builtin.include_role:
        name: kea_validate

- name: Reload Kea service
  when: kea_ops_action == 'reload'
  tags:
    - ops
    - reload
  block:
    - name: Reload Kea systemd unit
      ansible.builtin.systemd:
        name: "{{ kea_deploy_systemd_unit_name }}"
        state: restarted
      when: kea_deploy_manage_systemd | bool

    - name: Reload Kea pod (non-systemd)
      ansible.builtin.command: "podman pod restart {{ kea_deploy_pod_name }}"
      register: kea_deploy_reload
      changed_when: kea_deploy_reload.rc == 0
      failed_when: kea_deploy_reload.rc != 0
      when: not kea_deploy_manage_systemd | bool

- name: Report Kea status
  when: kea_ops_action == 'status'
  tags:
    - ops
    - status
  block:
    - name: Read Kea container running state
      ansible.builtin.command: "podman inspect {{ kea_deploy_container_name }} --format {{ '{{.State.Running}}' }}"
      register: kea_deploy_container_running
      changed_when: false
      failed_when: false

    - name: Read Kea health status
      ansible.builtin.uri:
        url: "{{ kea_deploy_health_url_effective }}"
        method: GET
        validate_certs: "{{ kea_deploy_validate_certs }}"
      register: kea_deploy_health
      changed_when: false
      failed_when: false
      when: kea_deploy_health_url_effective | default('') | length > 0

    - name: Default Kea health status when no URL configured
      ansible.builtin.set_fact:
        kea_deploy_health: {}
      when: kea_deploy_health_url_effective | default('') | length == 0

    - name: Report Kea container state
      ansible.builtin.debug:
        msg: >-
          health={{ kea_deploy_health.status | default('unknown') }},
          running={{ kea_deploy_container_running.stdout | default('unknown') | trim }}

- name: Upgrade Kea image
  when: kea_ops_action == 'upgrade'
  tags:
    - ops
    - upgrade
  block:
    - name: Require kea_ops_target_image
      ansible.builtin.assert:
        that:
          - kea_ops_target_image | length > 0
        fail_msg: "kea_ops_target_image must be set for upgrade."

    - name: Set Kea image override
      ansible.builtin.set_fact:
        kea_deploy_image: "{{ kea_ops_target_image }}"

    - name: Redeploy Kea with new image
      ansible.builtin.include_role:
        name: kea_deploy
