---
- name: Ensure MinIO directories exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default(minio_deploy_run_as_user) }}"
    group: "{{ item.group | default(minio_deploy_run_as_group) }}"
    mode: "{{ item.mode }}"
  loop:
    - path: "{{ minio_deploy_host_data_dir }}"
      mode: '0750'
    - path: "{{ minio_deploy_config_dir }}"
      mode: '0750'
    - path: "{{ minio_deploy_cert_dir }}"
      mode: '0750'
    - path: "{{ minio_deploy_pod_manifest_path | dirname }}"
      owner: root
      group: root
      mode: '0755'
  when: item.path | default('') | length > 0
  notify:
    - Recreate minio pod
    - Run minio pod
  tags:
    - deployment

- name: Render MinIO Pod manifest
  ansible.builtin.template:
    src: minio-pod.yml.j2
    dest: "{{ minio_deploy_pod_manifest_path }}"
    mode: '0644'
  notify:
    - Recreate minio pod
    - Run minio pod
  tags:
    - deployment

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
  tags:
    - deployment

- name: Recreate minio pod (kubeplay)
  when:
    - minio_deploy_kubeplay_remove | default(false)
    - not minio_deploy_skip_runtime | bool
  tags:
    - deployment
  block:
    - name: Run kubeplay remove (best effort)
      ansible.builtin.include_role:
        name: lit.foundational.kubeplay
      vars:
        kubeplay_apps: []
        kubeplay_action: remove
        kubeplay_pod_name: "{{ minio_deploy_pod_name }}"
        kubeplay_app_name: minio_remove
  rescue:
    - name: Ignore kubeplay remove failure
      ansible.builtin.debug:
        msg: "Skipping kubeplay remove failure."

- name: Run minio pod (kubeplay)
  when:
    - minio_deploy_kubeplay_run | default(false)
    - not minio_deploy_skip_runtime | bool
  tags:
    - deployment
  block:
    - name: Run kubeplay run (best effort)
      ansible.builtin.include_role:
        name: lit.foundational.kubeplay
      vars:
        kubeplay_apps: []
        kubeplay_action: run
        kubeplay_pod_name: "{{ minio_deploy_pod_name }}"
        kubeplay_pod_manifest_path: "{{ minio_deploy_pod_manifest_path }}"
        kubeplay_app_name: minio_run
  rescue:
    - name: Ignore kubeplay run failure
      ansible.builtin.debug:
        msg: "Skipping kubeplay run failure."
