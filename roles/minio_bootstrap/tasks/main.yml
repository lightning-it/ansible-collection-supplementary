---
- name: Ensure required MinIO vars are defined
  ansible.builtin.import_role:
    name: minio_deploy
    tasks_from: assert
  tags: always

- name: Ensure bootstrap bucket list is valid
  ansible.builtin.assert:
    that:
      - minio_deploy_bootstrap_buckets is sequence
    fail_msg: "minio_deploy_bootstrap_buckets must be a list."
  tags: always

- name: Skip MinIO bootstrap when disabled
  ansible.builtin.debug:
    msg: "MinIO bootstrap skipped (minio_deploy_skip_bootstrap=true or no buckets requested)."
  when:
    - minio_deploy_skip_bootstrap | bool or minio_deploy_bootstrap_buckets | length == 0
  tags: always

- name: Configure MinIO mc alias
  ansible.builtin.command: >-
    {{ minio_deploy_mc_path }} alias set {{ minio_deploy_mc_alias }} {{ minio_deploy_api_url_effective }}
    {{ minio_deploy_root_user_effective }} {{ minio_deploy_root_password_effective }}
    {{ (minio_deploy_mc_insecure | bool) | ternary('--insecure', '') }}
  register: minio_deploy_mc_alias_set
  changed_when: false
  no_log: true
  when:
    - not minio_deploy_skip_bootstrap | bool
    - minio_deploy_bootstrap_buckets | length > 0
  tags:
    - bootstrap

- name: Create MinIO buckets
  ansible.builtin.command: "{{ minio_deploy_mc_path }} mb --ignore-existing {{ minio_deploy_mc_alias }}/{{ item }}"
  register: minio_deploy_bucket_create
  changed_when: "'created' in minio_deploy_bucket_create.stdout | default('')"
  loop: "{{ minio_deploy_bootstrap_buckets }}"
  when:
    - not minio_deploy_skip_bootstrap | bool
    - minio_deploy_bootstrap_buckets | length > 0
  tags:
    - bootstrap

- name: Publish tfstate backend facts
  ansible.builtin.set_fact:
    tfstate_backend_ready: true
    tfstate_s3_endpoint: >-
      {{
        minio_bootstrap_tfstate_endpoint
          | default(minio_deploy_api_url_effective, true)
      }}
    tfstate_bucket: "{{ minio_bootstrap_tfstate_bucket }}"
    tfstate_access_key: "{{ minio_bootstrap_tfstate_access_key }}"
    tfstate_secret_key: "{{ minio_bootstrap_tfstate_secret_key }}"
    tfstate_region: "{{ minio_bootstrap_tfstate_region | default(omit) }}"
    tfstate_key_prefix: "{{ minio_bootstrap_tfstate_key_prefix | default(omit) }}"
  no_log: true
  when:
    - not minio_deploy_skip_bootstrap | bool
    - minio_bootstrap_tfstate_bucket | default('', true) | length > 0
    - minio_bootstrap_tfstate_access_key | default('', true) | length > 0
    - minio_bootstrap_tfstate_secret_key | default('', true) | length > 0
  tags:
    - bootstrap

- name: Migrate pending tfstate directories
  ansible.builtin.include_tasks: migrate_pending_dir.yml
  when:
    - tfstate_backend_ready | default(false) | bool
    - tfstate_s3_endpoint | default('', true) | length > 0
    - tfstate_bucket | default('', true) | length > 0
    - tfstate_access_key | default('', true) | length > 0
    - tfstate_secret_key | default('', true) | length > 0
    - tfstate_pending_dirs is defined
    - tfstate_pending_dirs | length > 0
  loop: "{{ tfstate_pending_dirs }}"
  loop_control:
    loop_var: minio_bootstrap_pending_dir
  tags:
    - bootstrap
