---
- name: Ensure required MinIO vars are defined
  ansible.builtin.import_role:
    name: minio_deploy
    tasks_from: assert
  tags: always

- name: Ensure bootstrap bucket list is valid
  ansible.builtin.assert:
    that:
      - minio_deploy_bootstrap_buckets is sequence
    fail_msg: "minio_deploy_bootstrap_buckets must be a list."
  tags: always

- name: Skip MinIO bootstrap when disabled
  ansible.builtin.debug:
    msg: "MinIO bootstrap skipped (minio_deploy_skip_bootstrap=true or no buckets requested)."
  when:
    - minio_deploy_skip_bootstrap | bool or minio_deploy_bootstrap_buckets | length == 0
  tags: always

- name: Configure MinIO mc alias
  ansible.builtin.command: >-
    {{ minio_deploy_mc_path }} alias set {{ minio_deploy_mc_alias }} {{ minio_deploy_api_url_effective }}
    {{ minio_deploy_root_user_effective }} {{ minio_deploy_root_password_effective }}
    {{ (minio_deploy_mc_insecure | bool) | ternary('--insecure', '') }}
  register: minio_deploy_mc_alias_set
  changed_when: false
  no_log: true
  when:
    - not minio_deploy_skip_bootstrap | bool
    - minio_deploy_bootstrap_buckets | length > 0
  tags:
    - bootstrap

- name: Create MinIO buckets
  ansible.builtin.command: "{{ minio_deploy_mc_path }} mb --ignore-existing {{ minio_deploy_mc_alias }}/{{ item }}"
  register: minio_deploy_bucket_create
  changed_when: "'created' in minio_deploy_bucket_create.stdout | default('')"
  loop: "{{ minio_deploy_bootstrap_buckets }}"
  when:
    - not minio_deploy_skip_bootstrap | bool
    - minio_deploy_bootstrap_buckets | length > 0
  tags:
    - bootstrap
