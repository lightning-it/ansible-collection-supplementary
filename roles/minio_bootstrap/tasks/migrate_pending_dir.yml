---
- name: Check pending tfstate directory exists
  ansible.builtin.stat:
    path: "{{ minio_bootstrap_pending_dir }}"
  register: minio_bootstrap_pending_dir_stat
  changed_when: false
  delegate_to: localhost

- name: Migrate tfstate files from pending directory
  when: minio_bootstrap_pending_dir_stat.stat.exists
  block:
    - name: Find local tfstate files in pending directory
      ansible.builtin.find:
        paths: "{{ minio_bootstrap_pending_dir }}"
        patterns:
          - "*.tfstate"
          - "*.tfstate.backup"
          - "*.tfstate.*"
        recurse: false
        file_type: file
      register: minio_bootstrap_pending_tfstate_files
      changed_when: false
      delegate_to: localhost

    - name: Migrate pending tfstate files to backend
      ansible.builtin.include_role:
        name: lit.foundational.terraform_state_migrate
      vars:
        terraform_state_migrate_local_root: "{{ minio_bootstrap_pending_dir }}"
        terraform_state_migrate_s3_endpoint: "{{ tfstate_s3_endpoint }}"
        terraform_state_migrate_s3_bucket: "{{ tfstate_bucket }}"
        terraform_state_migrate_s3_access_key: "{{ tfstate_access_key }}"
        terraform_state_migrate_s3_secret_key: "{{ tfstate_secret_key }}"
      when: minio_bootstrap_pending_tfstate_files.matched | int > 0
      no_log: true
      delegate_to: localhost

    - name: Remove local tfstate files after migration
      ansible.builtin.file:
        path: "{{ minio_bootstrap_tfstate_file.path }}"
        state: absent
      loop: "{{ minio_bootstrap_pending_tfstate_files.files }}"
      loop_control:
        loop_var: minio_bootstrap_tfstate_file
      when: minio_bootstrap_pending_tfstate_files.matched | int > 0
      delegate_to: localhost
  rescue:
    - name: Skip tfstate cleanup after failed migration
      ansible.builtin.debug:
        msg: "Skipping tfstate cleanup for {{ minio_bootstrap_pending_dir }} after migration failure."
