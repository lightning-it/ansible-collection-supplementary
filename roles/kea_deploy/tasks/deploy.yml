---
- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ ansible_os_family }}.yml"
  when: ansible_os_family == 'RedHat'

- name: Deploy Kea runtime
  when:
    - not kea_deploy_skip_runtime | bool
    - not kea_deploy_skip_deploy | bool
  block:
    - name: Ensure required packages are installed
      ansible.builtin.include_tasks: install_packages.yml
      when: kea_deploy_install_packages | bool
      tags:
        - install

    - name: Deploy Kea Pod
      ansible.builtin.include_tasks: deploy_pod.yml
      tags:
        - deployment

    - name: Install systemd unit for Kea Pod
      ansible.builtin.include_tasks: systemd.yml
      when: kea_deploy_manage_systemd | bool
      tags:
        - systemd

    - name: Wait until Kea health endpoint is reachable (non-systemd)
      ansible.builtin.uri:
        url: "{{ kea_deploy_health_url_effective }}"
        method: GET
        validate_certs: "{{ kea_deploy_validate_certs }}"
      register: kea_deploy_health
      until: kea_deploy_health.status == 200
      retries: 30
      delay: 5
      changed_when: false
      failed_when: kea_deploy_health is failed or kea_deploy_health.status != 200
      when:
        - not kea_deploy_manage_systemd | bool
        - kea_deploy_health_url_effective | default('') | length > 0
      tags:
        - deployment
        - api
