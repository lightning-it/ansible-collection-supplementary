---
- name: Wait until Vault API is reachable via HTTPS
  ansible.builtin.uri:
    url: "{{ vault_health_url }}"
    method: GET
    validate_certs: "{{ vault_vault_validate_certs }}"
  register: vault_health
  until: vault_health.status in [200, 429, 472, 473, 501, 503]
  retries: 30
  delay: 5
  changed_when: false
  failed_when: vault_health is failed and vault_health.status not in [200, 429, 472, 473, 501, 503]
  tags:
    - bootstrap
    - api

- name: Initialize Vault
  ansible.builtin.include_tasks: init.yml
  tags:
    - bootstrap
    - init

- name: Unseal Vault
  ansible.builtin.include_tasks: unseal.yml
  tags:
    - bootstrap
    - unseal
