---
- name: Ensure directories exist for podman volumes
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: 200
    group: 200
    mode: '0755'
  loop:
    - "{{ nexus_nexus_data_dir }}"
    - "{{ nexus_caddy_config_dir }}"
    - "{{ nexus_caddy_certs_dir }}"
    - "{{ nexus_pod_manifest_path | dirname }}"
  tags:
    - deployment

- name: Detect SELinux status
  ansible.builtin.command: getenforce
  register: selinux_status
  changed_when: false
  failed_when: false
  tags:
    - deployment

- name: Read SELinux context for Nexus & Caddy data dirs
  ansible.builtin.command: "stat -c %C {{ item }}"
  register: nexus_selinux_context
  changed_when: false
  failed_when: false
  loop:
    - "{{ nexus_nexus_data_dir }}"
    - "{{ nexus_caddy_config_dir }}"
    - "{{ nexus_caddy_certs_dir }}"
  when: selinux_status.stdout == "Enforcing" or selinux_status.stdout == "Permissive"
  tags:
    - deployment

- name: Apply SELinux context for Nexus & Caddy data dirs
  ansible.builtin.command: "chcon -Rt container_file_t {{ item.item }}"
  register: nexus_selinux_relabel
  changed_when: nexus_selinux_relabel.rc == 0
  failed_when: false
  loop: "{{ nexus_selinux_context.results }}"
  when:
    - selinux_status.stdout == "Enforcing" or selinux_status.stdout == "Permissive"
    - item.stdout is not search("container_file_t")
  tags:
    - deployment

- name: Render Caddyfile
  ansible.builtin.template:
    src: Caddyfile-ssl.j2
    dest: "{{ nexus_caddy_config_dir }}/Caddyfile-ssl"
    mode: '0644'
  notify: Recreate nexus pod
  tags:
    - deployment

- name: Render Pod manifest
  ansible.builtin.template:
    src: nexus-pod.yml.j2
    dest: "{{ nexus_pod_manifest_path }}"
    mode: '0644'
  notify: Recreate nexus pod
  tags:
    - deployment

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
  tags:
    - deployment
