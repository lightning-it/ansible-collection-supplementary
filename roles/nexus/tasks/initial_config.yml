---
- name: Read nexus admin password from Vault (if exists)
  delegate_to: localhost
  community.hashi_vault.vault_kv2_get:
    url: "{{ nexus_vault_address }}"
    engine_mount_point: "{{ nexus_engine_mount_point }}"
    auth_method: "{{ nexus_vault_auth_method }}"
    role_id: "{{ nexus_vault_kv_role_id | default('') }}"
    secret_id: "{{ nexus_vault_kv_secret_id | default('') }}"
    validate_certs: "{{ nexus_vault_validate_certs }}"
    path: "{{ inventory_hostname }}/nexus/admin"
  register: vault_nexus_admin_password
  failed_when: false
  no_log: true
  tags:
    - sonatype_nexus_config
    - config

- name: Wait until Nexus API is ready
  ansible.builtin.uri:
    url: "https://{{ nexus_nexus_hostname }}/service/rest/v1/status"
    method: GET
    validate_certs: "{{ nexus_validate_certs }}"
  register: result
  until: result.status == 200
  retries: 30
  delay: 10
  tags:
    - sonatype_nexus_config

- name: Check if initial admin password file exists
  ansible.builtin.stat:
    path: "{{ nexus_nexus_data_dir }}/admin.password"
  register: admin_pwd_file_stat
  tags:
    - sonatype_nexus_config

- name: Set target admin password from Vault
  ansible.builtin.set_fact:
    nexus_nexus_target_admin_password: "{{ vault_nexus_admin_password.data.data.password }}"
  when: nexus_nexus_target_admin_password is not defined and
        vault_nexus_admin_password.data is defined and
        vault_nexus_admin_password.data.data.password is defined
  no_log: true
  tags:
    - sonatype_nexus_config

- name: Set target admin password on first boot
  when: nexus_nexus_target_admin_password is not defined and
        admin_pwd_file_stat.stat.exists
  ansible.builtin.set_fact:
    nexus_nexus_target_admin_password: "{{ lookup('community.general.random_string', length=32) }}"
  no_log: true
  tags:
    - sonatype_nexus_config

- name: Fail when Nexus admin password is unknown
  when: nexus_nexus_target_admin_password is not defined
  ansible.builtin.fail:
    msg: >-
      Nexus admin password not found in Vault and admin.password is missing.
      Restore the Vault secret or set nexus_nexus_target_admin_password.
  tags:
    - sonatype_nexus_config

- name: Validate Nexus admin credentials
  ansible.builtin.uri:
    url: "https://{{ nexus_nexus_hostname }}/service/rest/v1/security/users/{{ nexus_nexus_target_admin_username }}"
    method: GET
    user: "{{ nexus_nexus_target_admin_username }}"
    password: "{{ nexus_nexus_target_admin_password }}"
    force_basic_auth: true
    validate_certs: "{{ nexus_validate_certs }}"
    status_code: 200
  register: nexus_admin_auth_check
  failed_when: false
  no_log: true
  tags:
    - sonatype_nexus_config

- name: Fail when Nexus admin credentials are invalid
  ansible.builtin.fail:
    msg: >-
      Nexus admin credentials rejected (HTTP {{ nexus_admin_auth_check.status | default('unknown') }}).
      Update the Vault secret or set nexus_nexus_target_admin_password.
  when: nexus_admin_auth_check.status | default(0) != 200
  tags:
    - sonatype_nexus_config

- name: Get initial password
  when: admin_pwd_file_stat.stat.exists
  tags:
    - sonatype_nexus_config
  block:
    - name: Read generated admin password
      ansible.builtin.slurp:
        src: "{{ nexus_nexus_data_dir }}/admin.password"
      register: admin_pwd_file
      no_log: true

    - name: Set fact
      ansible.builtin.set_fact:
        nexus_nexus_initial_admin_password: "{{ admin_pwd_file['content'] | b64decode | trim }}"
      no_log: true

    - name: Set new admin password
      ansible.builtin.uri:
        url: "https://{{ nexus_nexus_hostname }}/service/rest/v1/security/users/admin/change-password"
        method: PUT
        user: "{{ nexus_nexus_target_admin_username }}"
        password: "{{ nexus_nexus_initial_admin_password }}"
        body: "{{ nexus_nexus_target_admin_password }}"
        headers:
          Content-Type: text/plain
          accept: application/json
        body_format: raw
        force_basic_auth: true
        validate_certs: "{{ nexus_validate_certs }}"
        status_code: 204
      register: nexus_admin_password_change
      no_log: true

- name: Record admin password change
  ansible.builtin.set_fact:
    nexus_admin_password_changed: true
  when: nexus_admin_password_change is defined and
        (nexus_admin_password_change.get('status', 0) | int) == 204
  no_log: true
  tags:
    - sonatype_nexus_config

- name: Write Nexus admin password to Vault
  delegate_to: localhost
  community.hashi_vault.vault_kv2_write:
    url: "{{ nexus_vault_address }}"
    engine_mount_point: "{{ nexus_engine_mount_point }}"
    auth_method: "{{ nexus_vault_auth_method }}"
    role_id: "{{ nexus_vault_kv_role_id | default('') }}"
    secret_id: "{{ nexus_vault_kv_secret_id | default('') }}"
    validate_certs: "{{ nexus_vault_validate_certs }}"
    path: "{{ inventory_hostname }}/nexus/admin"
    data:
      password: "{{ nexus_nexus_target_admin_password }}"
  no_log: true
  when: nexus_admin_password_changed | default(false)
  tags:
    - sonatype_nexus_config

- name: Set Anonymous access to {{ nexus_nexus_disable_anonymous }}
  vars:
    nexus_anonymous_enabled: "{{ (not nexus_nexus_disable_anonymous) | bool }}"
  ansible.builtin.uri:
    url: "https://{{ nexus_nexus_hostname }}/service/rest/v1/security/anonymous"
    user: "{{ nexus_nexus_target_admin_username }}"
    password: "{{ nexus_nexus_target_admin_password }}"
    method: PUT
    force_basic_auth: true
    validate_certs: "{{ nexus_validate_certs }}"
    status_code: [200, 204]
    body:
      enabled: "{{ nexus_anonymous_enabled }}"
      userId: "anonymous"
      realmName: "NexusAuthorizingRealm"
    body_format: json
  no_log: true
  tags:
    - sonatype_nexus_config

- name: Configure Nexus HTTP/HTTPS proxy via ExtDirect API
  vars:
    http_data:
      httpEnabled: "{{ nexus_http_proxy_enabled }}"
      httpAuthEnabled: "{{ nexus_http_proxy_auth_enabled }}"
      httpHost: "{{ nexus_http_proxy_host }}"
      httpPort: "{{ nexus_http_proxy_port }}"
      httpAuthUsername: "{{ nexus_http_proxy_auth_username }}"
      httpAuthPassword: "{{ nexus_http_proxy_auth_password }}"
    https_data:
      httpsEnabled: "{{ nexus_https_proxy_enabled }}"
      httpsAuthEnabled: "{{ nexus_https_proxy_auth_enabled }}"
      httpsHost: "{{ nexus_https_proxy_host }}"
      httpsPort: "{{ nexus_https_proxy_port }}"
      httpsAuthUsername: "{{ nexus_https_proxy_auth_username }}"
      httpsAuthPassword: "{{ nexus_https_proxy_auth_password }}"
  ansible.builtin.uri:
    url: "https://{{ nexus_nexus_hostname }}/service/extdirect"
    method: POST
    user: "{{ nexus_nexus_target_admin_username }}"
    password: "{{ nexus_nexus_target_admin_password }}"
    force_basic_auth: true
    validate_certs: "{{ nexus_validate_certs }}"
    headers:
      Content-Type: "application/json"
    body_format: json
    body:
      action: coreui_HttpSettings
      method: update
      type: rpc
      tid: 1
      data:
        - httpEnabled: "{{ nexus_http_proxy_enabled }}"
          httpAuthEnabled: "{{ nexus_http_proxy_auth_enabled }}"
          httpHost: "{{ nexus_http_proxy_host }}"
          httpPort: "{{ nexus_http_proxy_port }}"
          httpAuthUsername: "{{ nexus_http_proxy_auth_username }}"
          httpAuthPassword: "{{ nexus_http_proxy_auth_password }}"
          httpsEnabled: "{{ nexus_https_proxy_enabled }}"
          httpsAuthEnabled: "{{ nexus_https_proxy_auth_enabled }}"
          httpsHost: "{{ nexus_https_proxy_host }}"
          httpsPort: "{{ nexus_https_proxy_port }}"
          httpsAuthUsername: "{{ nexus_https_proxy_auth_username }}"
          httpsAuthPassword: "{{ nexus_https_proxy_auth_password }}"
          nonProxyHosts: []
          timeout: null
          retries: null
    status_code: 200
  register: nexus_proxy_settings
  no_log: true
  tags:
    - sonatype_nexus_config
