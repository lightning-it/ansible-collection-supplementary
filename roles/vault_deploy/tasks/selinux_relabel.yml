---
- name: Detect SELinux status
  ansible.builtin.command: getenforce
  register: vault_deploy_selinux_status
  changed_when: false
  failed_when: false
  when: ansible_os_family in ['RedHat', 'CentOS']
  tags:
    - selinux

- name: Read Vault container mount label
  ansible.builtin.command: "podman inspect {{ vault_deploy_container_name }} --format {{ '{{.MountLabel}}' }}"
  register: vault_deploy_mount_label
  changed_when: false
  failed_when: false
  tags:
    - selinux
  when:
    - ansible_os_family in ['RedHat', 'CentOS']
    - vault_deploy_selinux_relabel | bool
    - vault_deploy_selinux_status.stdout is defined
    - vault_deploy_selinux_status.stdout != 'Disabled'

- name: Parse Vault container mount label
  ansible.builtin.set_fact:
    vault_deploy_mount_label_parts: "{{ (vault_deploy_mount_label.stdout | trim).split(':') }}"
  tags:
    - selinux
  when:
    - vault_deploy_mount_label.stdout is defined
    - vault_deploy_mount_label.stdout | trim | length > 0

- name: Set Vault container mount label pieces
  ansible.builtin.set_fact:
    vault_deploy_mount_label_type: "{{ vault_deploy_mount_label_parts[2] }}"
    vault_deploy_mount_label_level: "{{ vault_deploy_mount_label_parts[3:] | join(':') }}"
  tags:
    - selinux
  when:
    - vault_deploy_mount_label_parts is defined
    - vault_deploy_mount_label_parts | length > 3

- name: Read current SELinux label for Vault data dir
  ansible.builtin.command: "stat -c %C {{ vault_deploy_host_data_dir }}"
  register: vault_deploy_mount_label_current
  changed_when: false
  failed_when: false
  tags:
    - selinux
  when:
    - ansible_os_family in ['RedHat', 'CentOS']
    - vault_deploy_selinux_relabel | bool
    - vault_deploy_selinux_status.stdout is defined
    - vault_deploy_selinux_status.stdout != 'Disabled'
    - vault_deploy_mount_label_level is defined
    - vault_deploy_mount_label_level | length > 0

- name: Parse current SELinux label
  ansible.builtin.set_fact:
    vault_deploy_mount_label_current_parts: "{{ (vault_deploy_mount_label_current.stdout | trim).split(':') }}"
  tags:
    - selinux
  when:
    - vault_deploy_mount_label_current.stdout is defined
    - vault_deploy_mount_label_current.stdout | trim | length > 0

- name: Set current SELinux label pieces
  ansible.builtin.set_fact:
    vault_deploy_mount_label_current_type: "{{ vault_deploy_mount_label_current_parts[2] }}"
    vault_deploy_mount_label_current_level: "{{ vault_deploy_mount_label_current_parts[3:] | join(':') }}"
  tags:
    - selinux
  when:
    - vault_deploy_mount_label_current_parts is defined
    - vault_deploy_mount_label_current_parts | length > 3

- name: Apply Vault mount label to data dir
  ansible.builtin.command: >-
    chcon -R -t {{ vault_deploy_mount_label_type }}
    -l {{ vault_deploy_mount_label_level }}
    {{ vault_deploy_host_data_dir }}
  register: vault_deploy_mount_label_apply
  changed_when: vault_deploy_mount_label_apply.rc == 0
  tags:
    - selinux
  when:
    - ansible_os_family in ['RedHat', 'CentOS']
    - vault_deploy_selinux_relabel | bool
    - vault_deploy_selinux_status.stdout is defined
    - vault_deploy_selinux_status.stdout != 'Disabled'
    - vault_deploy_mount_label_type is defined
    - vault_deploy_mount_label_level is defined
    - vault_deploy_mount_label_level | length > 0
    - vault_deploy_mount_label_current_type is defined
    - vault_deploy_mount_label_current_level is defined
    - >
      vault_deploy_mount_label_current_type != vault_deploy_mount_label_type
      or vault_deploy_mount_label_current_level != vault_deploy_mount_label_level
