---
- name: Apply SELinux context for Vault paths
  when:
    - vault_deploy_selinux_relabel | bool
    - ansible_selinux is defined
    - (ansible_selinux.status | default('disabled')) == 'enabled'
  block:
    - name: Persist SELinux fcontext for Vault data/certs/config
      community.general.sefcontext:
        target: "{{ item }}"
        setype: "container_file_t"
        state: present
      loop:
        - "{{ vault_deploy_host_data_dir }}(/.*)?"
        - "{{ vault_deploy_cert_dir }}(/.*)?"
        - "{{ vault_deploy_config_dir }}(/.*)?"
      tags:
        - selinux

    - name: Restore SELinux context for Vault data/certs/config
      ansible.builtin.command: >-
        restorecon -Rv
        {{ vault_deploy_host_data_dir }}
        {{ vault_deploy_cert_dir }}
        {{ vault_deploy_config_dir }}
      changed_when: false
      tags:
        - selinux
