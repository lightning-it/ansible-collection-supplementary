---
- name: Ensure data and cert directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ vault_deploy_run_as_user | default(100) }}"
    group: "{{ vault_deploy_run_as_group | default(1000) }}"
    mode: '0755'
  loop:
    - "{{ vault_deploy_host_data_dir | dirname }}"
    - "{{ vault_deploy_cert_dir }}"
    - "{{ vault_deploy_config_dir }}"
    - "{{ vault_deploy_pod_manifest_path | dirname }}"
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment

- name: Ensure Vault data subdirectories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ vault_deploy_run_as_user | default(100) }}"
    group: "{{ vault_deploy_run_as_group | default(1000) }}"
    mode: '0700'
  loop:
    - "{{ vault_deploy_host_data_dir }}"
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment

- name: Ensure Vault data directory permissions
  ansible.builtin.file:
    path: "{{ vault_deploy_host_data_dir }}"
    state: directory
    owner: "{{ vault_deploy_run_as_user | default(100) }}"
    group: "{{ vault_deploy_run_as_group | default(1000) }}"
    mode: '0700'
  tags:
    - deployment

- name: Ensure Vault data directory ownership
  ansible.builtin.file:
    path: "{{ vault_deploy_host_data_dir }}"
    state: directory
    owner: "{{ vault_deploy_run_as_user | default(100) }}"
    group: "{{ vault_deploy_run_as_group | default(1000) }}"
    recurse: true
  tags:
    - deployment

- name: Detect SELinux status
  ansible.builtin.command: getenforce
  register: selinux_status
  changed_when: false
  failed_when: false
  when:
    - ansible_distribution in ['RedHat', 'CentOS']
    - vault_deploy_selinux_relabel | bool

- name: Set Vault container name
  ansible.builtin.set_fact:
    vault_deploy_container_name: "{{ vault_deploy_pod_name }}-vault"
  when: vault_deploy_pod_name is defined

- name: Check SELinux context for Vault mounts
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ vault_deploy_host_data_dir }}"
    - "{{ vault_deploy_cert_dir }}"
    - "{{ vault_deploy_config_dir }}"
  register: selinux_contexts
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - ansible_distribution in ['RedHat', 'CentOS']
    - vault_deploy_selinux_relabel | bool
    - selinux_status.stdout is defined
    - selinux_status.stdout != 'Disabled'

- name: Apply SELinux context
  ansible.builtin.command: >-
    chcon -Rt container_file_t
    {{ vault_deploy_host_data_dir }}
    {{ vault_deploy_cert_dir }}
    {{ vault_deploy_config_dir }}
  register: selinux_cmd
  changed_when: selinux_type_missing | bool
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment
  when:
    - ansible_distribution in ['RedHat', 'CentOS']
    - vault_deploy_selinux_relabel | bool
    - selinux_status.stdout is defined
    - selinux_status.stdout != 'Disabled'
    - selinux_contexts is defined
    - selinux_contexts.results is defined
    - selinux_type_missing | bool
  vars:
    selinux_contexts_defined: >-
      {{
        selinux_contexts.results
        | selectattr('stat.selinux_context', 'defined')
        | list
      }}
    selinux_type_missing: >-
      {{
        (selinux_contexts_defined
         | rejectattr('stat.selinux_context', 'search', 'container_file_t')
         | list
         | length)
        > 0
      }}

- name: Render Vault Pod manifest
  ansible.builtin.template:
    src: vault-pod.yml.j2
    dest: "{{ vault_deploy_pod_manifest_path }}"
    mode: '0644'
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment

- name: Render Vault config
  ansible.builtin.template:
    src: vau-config.hcl.j2
    dest: "{{ vault_deploy_config_dir }}/vault.hcl"
    mode: '0644'
  notify:
    - Recreate vault pod
    - Run vault pod
  tags:
    - deployment

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
  tags:
    - deployment

- name: Recreate vault pod (kubeplay)
  when:
    - vault_deploy_kubeplay_remove | default(false)
    - not vault_deploy_skip_runtime | bool
  tags:
    - deployment
  block:
    - name: Run kubeplay remove (best effort)
      ansible.builtin.include_role:
        name: lit.foundational.kubeplay
      vars:
        kubeplay_apps: []
        kubeplay_action: remove
        kubeplay_pod_name: "{{ vault_deploy_pod_name }}"
        kubeplay_app_name: vault_remove
  rescue:
    - name: Ignore kubeplay remove failure
      ansible.builtin.debug:
        msg: "Skipping kubeplay remove failure."

- name: Run vault pod (kubeplay)
  when:
    - vault_deploy_kubeplay_run | default(false)
    - not vault_deploy_skip_runtime | bool
  tags:
    - deployment
  block:
    - name: Run kubeplay run (best effort)
      ansible.builtin.include_role:
        name: lit.foundational.kubeplay
      vars:
        kubeplay_apps: []
        kubeplay_action: run
        kubeplay_pod_name: "{{ vault_deploy_pod_name }}"
        kubeplay_pod_manifest_path: "{{ vault_deploy_pod_manifest_path }}"
        kubeplay_app_name: vault_run
  rescue:
    - name: Ignore kubeplay run failure
      ansible.builtin.debug:
        msg: "Skipping kubeplay run failure."

- name: Read Vault container running state
  ansible.builtin.command: "podman inspect {{ vault_deploy_container_name }} --format {{ '{{.State.Running}}' }}"
  register: vault_deploy_container_running
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - vault_deploy_container_name is defined

- name: Read Podman rootless status
  ansible.builtin.command: "podman info --format {{ '{{.Host.Security.Rootless}}' }}"
  register: vault_deploy_podman_rootless
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - vault_deploy_container_name is defined

- name: Read Vault data dir ownership on host
  ansible.builtin.stat:
    path: "{{ vault_deploy_host_data_dir }}"
  register: vault_deploy_host_data_stat
  changed_when: false
  tags:
    - deployment


- name: Read Vault container uid map (inspect)
  ansible.builtin.command:
    argv:
      - podman
      - inspect
      - "{{ vault_deploy_container_name }}"
      - --format
      - "{% raw %}{{range .HostConfig.IDMappings.UidMap}}{{println .ContainerID .HostID .Size}}{{end}}{% endraw %}"
  register: vault_deploy_uid_map_inspect
  become: false
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - vault_deploy_container_name is defined

- name: Read Vault container gid map (inspect)
  ansible.builtin.command:
    argv:
      - podman
      - inspect
      - "{{ vault_deploy_container_name }}"
      - --format
      - "{% raw %}{{range .HostConfig.IDMappings.GidMap}}{{println .ContainerID .HostID .Size}}{{end}}{% endraw %}"
  register: vault_deploy_gid_map_inspect
  become: false
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - vault_deploy_container_name is defined

- name: Set Vault container uid/gid map lines (inspect)
  ansible.builtin.set_fact:
    vault_deploy_uid_map_lines: "{{ vault_deploy_uid_map_inspect.stdout_lines | default([]) }}"
    vault_deploy_gid_map_lines: "{{ vault_deploy_gid_map_inspect.stdout_lines | default([]) }}"
  tags:
    - deployment
  when:
    - vault_deploy_uid_map_inspect is defined
    - vault_deploy_gid_map_inspect is defined
    - vault_deploy_uid_map_inspect.rc | default(1) == 0
    - vault_deploy_gid_map_inspect.rc | default(1) == 0
    - vault_deploy_uid_map_inspect.stdout_lines is defined
    - vault_deploy_uid_map_inspect.stdout_lines | length > 0
    - vault_deploy_gid_map_inspect.stdout_lines is defined
    - vault_deploy_gid_map_inspect.stdout_lines | length > 0

- name: Read Vault container PID
  ansible.builtin.command: "podman inspect {{ vault_deploy_container_name }} --format {{ '{{.State.Pid}}' }}"
  register: vault_deploy_container_pid
  become: false
  changed_when: false
  failed_when: false
  tags:
    - deployment
  when:
    - vault_deploy_container_name is defined
    - (vault_deploy_uid_map_lines | default([]) | length == 0)
      or (vault_deploy_gid_map_lines | default([]) | length == 0)

- name: Read Vault container uid/gid maps (proc)
  ansible.builtin.command: "cat /proc/{{ vault_deploy_container_pid.stdout | trim }}/{{ item }}"
  register: vault_deploy_container_id_maps
  become: false
  changed_when: false
  failed_when: false
  tags:
    - deployment
  loop:
    - uid_map
    - gid_map
  when:
    - vault_deploy_container_pid.stdout is defined
    - vault_deploy_container_pid.stdout | trim | length > 0
    - vault_deploy_container_pid.stdout | trim | int > 0
    - (vault_deploy_uid_map_lines | default([]) | length == 0)
      or (vault_deploy_gid_map_lines | default([]) | length == 0)

- name: Set Vault container uid/gid map lines (proc)
  ansible.builtin.set_fact:
    vault_deploy_uid_map_lines: >-
      {{
        (vault_deploy_uid_map_lines | default([]) | length > 0)
        | ternary(
            vault_deploy_uid_map_lines,
            vault_deploy_container_id_maps.results[0].stdout_lines | default([])
          )
      }}
    vault_deploy_gid_map_lines: >-
      {{
        (vault_deploy_gid_map_lines | default([]) | length > 0)
        | ternary(
            vault_deploy_gid_map_lines,
            vault_deploy_container_id_maps.results[1].stdout_lines | default([])
          )
      }}
  tags:
    - deployment
  when:
    - vault_deploy_container_id_maps is defined
    - vault_deploy_container_id_maps.results is defined
    - vault_deploy_container_id_maps.results | length == 2
    - vault_deploy_container_id_maps.results[0].stdout_lines is defined
    - vault_deploy_container_id_maps.results[1].stdout_lines is defined
    - (vault_deploy_uid_map_lines | default([]) | length == 0)
      or (vault_deploy_gid_map_lines | default([]) | length == 0)

- name: Select Vault uid/gid map lines for run-as user/group
  ansible.builtin.set_fact:
    vault_deploy_uid_map_line: >-
      {% set target = vault_deploy_run_as_user | default(100) | int %}
      {% set ns = namespace(match='') %}
      {% for line in vault_deploy_uid_map_lines %}
      {%   set parts = line.split() %}
      {%   if parts | length >= 3 %}
      {%     set start = parts[0] | int %}
      {%     set size = parts[2] | int %}
      {%     if target >= start and target < start + size %}
      {%       set ns.match = line %}
      {%     endif %}
      {%   endif %}
      {% endfor %}
      {{ ns.match }}
    vault_deploy_gid_map_line: >-
      {% set target = vault_deploy_run_as_group | default(1000) | int %}
      {% set ns = namespace(match='') %}
      {% for line in vault_deploy_gid_map_lines %}
      {%   set parts = line.split() %}
      {%   if parts | length >= 3 %}
      {%     set start = parts[0] | int %}
      {%     set size = parts[2] | int %}
      {%     if target >= start and target < start + size %}
      {%       set ns.match = line %}
      {%     endif %}
      {%   endif %}
      {% endfor %}
      {{ ns.match }}
  tags:
    - deployment
  when:
    - vault_deploy_uid_map_lines is defined
    - vault_deploy_uid_map_lines | length > 0
    - vault_deploy_gid_map_lines is defined
    - vault_deploy_gid_map_lines | length > 0

- name: Parse Vault container uid/gid map ranges (selected)
  ansible.builtin.set_fact:
    vault_deploy_uid_map_parts: "{{ vault_deploy_uid_map_line.split() }}"
    vault_deploy_gid_map_parts: "{{ vault_deploy_gid_map_line.split() }}"
  tags:
    - deployment
  when:
    - vault_deploy_uid_map_parts is not defined
    - vault_deploy_gid_map_parts is not defined
    - vault_deploy_uid_map_line is defined
    - vault_deploy_uid_map_line | trim | length > 0
    - vault_deploy_gid_map_line is defined
    - vault_deploy_gid_map_line | trim | length > 0

- name: Calculate Vault host uid/gid from container map
  ansible.builtin.set_fact:
    vault_deploy_host_uid: >-
      {{
        (vault_deploy_uid_map_parts[1] | int)
        + ((vault_deploy_run_as_user | default(100) | int) - (vault_deploy_uid_map_parts[0] | int))
      }}
    vault_deploy_host_gid: >-
      {{
        (vault_deploy_gid_map_parts[1] | int)
        + ((vault_deploy_run_as_group | default(1000) | int) - (vault_deploy_gid_map_parts[0] | int))
      }}
  tags:
    - deployment
  when:
    - vault_deploy_uid_map_parts is defined
    - vault_deploy_gid_map_parts is defined
    - vault_deploy_uid_map_parts | length > 2
    - vault_deploy_gid_map_parts | length > 2
    - (vault_deploy_run_as_user | default(100) | int) >= (vault_deploy_uid_map_parts[0] | int)
    - >-
      (vault_deploy_run_as_user | default(100) | int)
      < (
        (vault_deploy_uid_map_parts[0] | int)
        + (vault_deploy_uid_map_parts[2] | int)
      )
    - (vault_deploy_run_as_group | default(1000) | int) >= (vault_deploy_gid_map_parts[0] | int)
    - >-
      (vault_deploy_run_as_group | default(1000) | int)
      < (
        (vault_deploy_gid_map_parts[0] | int)
        + (vault_deploy_gid_map_parts[2] | int)
      )

- name: Ensure Vault data dir ownership matches container mapping
  ansible.builtin.file:
    path: "{{ vault_deploy_host_data_dir }}"
    state: directory
    owner: "{{ vault_deploy_host_uid }}"
    group: "{{ vault_deploy_host_gid }}"
    recurse: true
  tags:
    - deployment
  when:
    - vault_deploy_host_uid is defined
    - vault_deploy_host_gid is defined

- name: Apply SELinux relabel for Vault data dir
  ansible.builtin.include_tasks: selinux_relabel.yml
  when: vault_deploy_selinux_relabel | bool
  tags:
    - deployment
    - selinux
