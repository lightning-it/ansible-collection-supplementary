---
- name: Ensure required Vault vars are defined
  ansible.builtin.import_role:
    name: vault_deploy
    tasks_from: assert
  tags: always

- name: Set validate mode
  ansible.builtin.set_fact:
    vault_validate_strict: "{{ vault_deploy_validate_mode != 'report' }}"
  tags: always

- name: Check Vault container running state
  ansible.builtin.command: "podman inspect {{ vault_deploy_container_name }} --format {{ '{{.State.Running}}' }}"
  register: vault_deploy_container_running
  changed_when: false
  failed_when: false
  tags:
    - validate
    - runtime

- name: Fail when Vault container is not running
  ansible.builtin.fail:
    msg: "Vault container {{ vault_deploy_container_name }} is not running."
  when:
    - vault_validate_strict | bool
    - vault_deploy_container_running.stdout | default('') | trim != 'true'
  tags:
    - validate
    - runtime

- name: Report Vault container running state
  ansible.builtin.debug:
    msg: "Vault container running: {{ vault_deploy_container_running.stdout | default('unknown') | trim }}"
  when: not vault_validate_strict | bool
  tags:
    - validate
    - runtime

- name: Read Vault data dir stats
  ansible.builtin.stat:
    path: "{{ vault_deploy_host_data_dir }}"
  register: vault_deploy_data_stat
  tags:
    - validate
    - storage

- name: Validate Vault data dir ownership and mode
  ansible.builtin.assert:
    that:
      - vault_deploy_data_stat.stat.exists
      - vault_deploy_data_stat.stat.uid == (vault_deploy_expected_uid | int)
      - vault_deploy_data_stat.stat.gid == (vault_deploy_expected_gid | int)
      - vault_deploy_data_stat.stat.mode == (vault_deploy_expected_mode | string)
    fail_msg: >-
      Vault data dir {{ vault_deploy_host_data_dir }} expected
      {{ vault_deploy_expected_uid }}:{{ vault_deploy_expected_gid }}
      mode {{ vault_deploy_expected_mode }}, got
      {{ vault_deploy_data_stat.stat.uid }}:{{ vault_deploy_data_stat.stat.gid }}
      mode {{ vault_deploy_data_stat.stat.mode }}.
  when: vault_validate_strict | bool
  tags:
    - validate
    - storage

- name: Report Vault data dir ownership and mode
  ansible.builtin.debug:
    msg: >-
      Vault data dir {{ vault_deploy_host_data_dir }}: uid={{ vault_deploy_data_stat.stat.uid }},
      gid={{ vault_deploy_data_stat.stat.gid }}, mode={{ vault_deploy_data_stat.stat.mode }}
  when: not vault_validate_strict | bool
  tags:
    - validate
    - storage

- name: Detect SELinux status
  ansible.builtin.command: getenforce
  register: vault_deploy_selinux_status
  changed_when: false
  failed_when: false
  when: ansible_distribution in ['RedHat', 'CentOS']
  tags:
    - validate
    - selinux

- name: Read Vault container mount label
  ansible.builtin.command: "podman inspect {{ vault_deploy_container_name }} --format {{ '{{.MountLabel}}' }}"
  register: vault_deploy_mount_label
  changed_when: false
  failed_when: false
  when:
    - ansible_distribution in ['RedHat', 'CentOS']
    - vault_deploy_selinux_status.stdout is defined
    - vault_deploy_selinux_status.stdout != 'Disabled'
  tags:
    - validate
    - selinux

- name: Parse Vault container mount label
  ansible.builtin.set_fact:
    vault_deploy_mount_label_parts: "{{ (vault_deploy_mount_label.stdout | trim).split(':') }}"
  when:
    - vault_deploy_mount_label.stdout | default('') | trim | length > 0
  tags:
    - validate
    - selinux

- name: Set Vault container mount label pieces
  ansible.builtin.set_fact:
    vault_deploy_mount_label_type: "{{ vault_deploy_mount_label_parts[2] }}"
    vault_deploy_mount_label_level: "{{ vault_deploy_mount_label_parts[3:] | join(':') }}"
  when:
    - vault_deploy_mount_label_parts is defined
    - vault_deploy_mount_label_parts | length > 3
  tags:
    - validate
    - selinux

- name: Read current SELinux label for Vault data dir
  ansible.builtin.command: "stat -c %C {{ vault_deploy_host_data_dir }}"
  register: vault_deploy_mount_label_current
  changed_when: false
  failed_when: false
  when:
    - ansible_distribution in ['RedHat', 'CentOS']
    - vault_deploy_selinux_status.stdout is defined
    - vault_deploy_selinux_status.stdout != 'Disabled'
  tags:
    - validate
    - selinux

- name: Parse current SELinux label
  ansible.builtin.set_fact:
    vault_deploy_mount_label_current_parts: "{{ (vault_deploy_mount_label_current.stdout | trim).split(':') }}"
  when:
    - vault_deploy_mount_label_current.stdout | default('') | trim | length > 0
  tags:
    - validate
    - selinux

- name: Set current SELinux label pieces
  ansible.builtin.set_fact:
    vault_deploy_mount_label_current_type: "{{ vault_deploy_mount_label_current_parts[2] }}"
    vault_deploy_mount_label_current_level: "{{ vault_deploy_mount_label_current_parts[3:] | join(':') }}"
  when:
    - vault_deploy_mount_label_current_parts is defined
    - vault_deploy_mount_label_current_parts | length > 3
  tags:
    - validate
    - selinux

- name: Fail when SELinux labels do not match container MCS
  ansible.builtin.fail:
    msg: >-
      SELinux label mismatch: container={{ vault_deploy_mount_label_type }}:{{ vault_deploy_mount_label_level }},
      host={{ vault_deploy_mount_label_current_type }}:{{ vault_deploy_mount_label_current_level }}.
  when:
    - vault_validate_strict | bool
    - vault_deploy_mount_label_level is defined
    - vault_deploy_mount_label_current_level is defined
    - >
      vault_deploy_mount_label_level != vault_deploy_mount_label_current_level
      or vault_deploy_mount_label_type != vault_deploy_mount_label_current_type
  tags:
    - validate
    - selinux

- name: Report SELinux label status
  ansible.builtin.debug:
    msg: >-
      SELinux label host={{ vault_deploy_mount_label_current_type }}:{{ vault_deploy_mount_label_current_level }},
      container={{ vault_deploy_mount_label_type }}:{{ vault_deploy_mount_label_level }}
  when:
    - not vault_validate_strict | bool
    - vault_deploy_mount_label_level is defined
    - vault_deploy_mount_label_current_level is defined
  tags:
    - validate
    - selinux

- name: Check Vault health endpoint
  ansible.builtin.uri:
    url: "{{ vault_deploy_health_url }}"
    method: GET
    validate_certs: "{{ vault_deploy_vault_validate_certs }}"
  register: vault_deploy_health
  changed_when: false
  failed_when: false
  tags:
    - validate
    - api

- name: Validate Vault health response
  ansible.builtin.assert:
    that:
      - vault_deploy_health.status in [200, 429, 472, 473, 501, 503]
    fail_msg: "Vault health check failed: status {{ vault_deploy_health.status }}."
  when: vault_validate_strict | bool
  tags:
    - validate
    - api

- name: Report Vault health response
  ansible.builtin.debug:
    msg: "Vault health status: {{ vault_deploy_health.status }}"
  when: not vault_validate_strict | bool
  tags:
    - validate
    - api

- name: Read Vault init status
  ansible.builtin.uri:
    url: "{{ vault_deploy_api_url }}/v1/sys/init"
    method: GET
    validate_certs: "{{ vault_deploy_vault_validate_certs }}"
  register: vault_deploy_init_status
  changed_when: false
  failed_when: false
  tags:
    - validate
    - api

- name: Read Vault seal status
  ansible.builtin.uri:
    url: "{{ vault_deploy_api_url }}/v1/sys/seal-status"
    method: GET
    validate_certs: "{{ vault_deploy_vault_validate_certs }}"
  register: vault_deploy_seal_status
  changed_when: false
  failed_when: false
  tags:
    - validate
    - api

- name: Report Vault init and seal status
  ansible.builtin.debug:
    msg: >-
      init={{ vault_deploy_init_status.json.initialized | default('unknown') }},
      sealed={{ vault_deploy_seal_status.json.sealed | default('unknown') }}
  tags:
    - validate
    - api

- name: Test Vault storage write access
  ansible.builtin.command: >-
    podman exec --user {{ vault_deploy_run_as_user | default(100) }}
    {{ vault_deploy_container_name }} sh -lc
    'touch {{ vault_deploy_container_data_dir }}/core/_write_test
    && rm -f {{ vault_deploy_container_data_dir }}/core/_write_test'
  register: vault_deploy_storage_write
  changed_when: false
  failed_when: false
  tags:
    - validate
    - storage

- name: Fail when Vault storage write test fails
  ansible.builtin.fail:
    msg: "Vault storage write test failed for {{ vault_deploy_container_data_dir }}/core."
  when:
    - vault_validate_strict | bool
    - vault_deploy_storage_write.rc | default(1) != 0
  tags:
    - validate
    - storage

- name: Report Vault storage write test result
  ansible.builtin.debug:
    msg: "Vault storage write test rc={{ vault_deploy_storage_write.rc | default('unknown') }}"
  when: not vault_validate_strict | bool
  tags:
    - validate
    - storage
