---
- name: Manage CoreDNS systemd unit
  when:
    - coredns_deploy_manage_systemd | bool
    - (ansible_service_mgr | default(ansible_facts.service_mgr | default(''))) == 'systemd'
  tags:
    - systemd
  block:
    - name: Escape kube play manifest path
      ansible.builtin.command:
        cmd: "systemd-escape {{ coredns_deploy_pod_manifest_path }}"
      register: coredns_deploy_systemd_name
      changed_when: false

    - name: Ensure podman-kube drop-in directory exists
      ansible.builtin.file:
        path: "/etc/systemd/system/podman-kube@{{ coredns_deploy_systemd_name.stdout }}.service.d"
        state: directory
        mode: '0755'

    - name: Enable and start Podman kube systemd unit
      ansible.builtin.systemd:
        name: "podman-kube@{{ coredns_deploy_systemd_name.stdout }}.service"
        enabled: true
        state: started
        daemon_reload: true

    - name: Wait until CoreDNS health endpoint is reachable
      ansible.builtin.uri:
        url: "{{ coredns_deploy_health_url_effective }}"
        method: GET
        validate_certs: "{{ coredns_deploy_validate_certs }}"
      register: coredns_deploy_health
      until: coredns_deploy_health.status == 200
      retries: 30
      delay: 5
      changed_when: false
      failed_when: coredns_deploy_health is failed or coredns_deploy_health.status != 200
