---
- name: Manage CoreDNS systemd unit
  when:
    - coredns_deploy_manage_systemd | bool
    - (ansible_service_mgr | default(ansible_facts.service_mgr | default(''))) == 'systemd'
  tags:
    - systemd
  block:
    - name: Escape kube play manifest path
      ansible.builtin.command:
        cmd: "systemd-escape {{ coredns_deploy_pod_manifest_path }}"
      register: coredns_deploy_systemd_name
      changed_when: false

    - name: Ensure podman-kube drop-in directory exists
      ansible.builtin.file:
        path: "/etc/systemd/system/podman-kube@{{ coredns_deploy_systemd_name.stdout }}.service.d"
        state: directory
        mode: '0755'
      register: coredns_deploy_systemd_dropin

    - name: Read CoreDNS health port listener
      ansible.builtin.command: "ss -H -tln sport = :{{ coredns_deploy_host_health_port }}"
      register: coredns_deploy_health_listener
      changed_when: false
      failed_when: false

    - name: Read CoreDNS DNS port listener (TCP)
      ansible.builtin.command: "ss -H -tln sport = :{{ coredns_deploy_host_dns_port }}"
      register: coredns_deploy_dns_listener_tcp
      changed_when: false
      failed_when: false

    - name: Read CoreDNS DNS port listener (UDP)
      ansible.builtin.command: "ss -H -uln sport = :{{ coredns_deploy_host_dns_port }}"
      register: coredns_deploy_dns_listener_udp
      changed_when: false
      failed_when: false

    - name: Determine CoreDNS listener IPs
      ansible.builtin.set_fact:
        coredns_deploy_health_listener_ips: >-
          {{
            (
              coredns_deploy_health_listener.stdout
              | regex_findall('([0-9.]+):' ~ coredns_deploy_host_health_port)
              | default([])
            )
          }}
        coredns_deploy_dns_listener_ips: >-
          {{
            (
              (coredns_deploy_dns_listener_tcp.stdout | default(''))
              | regex_findall('([0-9.]+):' ~ coredns_deploy_host_dns_port)
              | default([])
            )
            +
            (
              (coredns_deploy_dns_listener_udp.stdout | default(''))
              | regex_findall('([0-9.]+):' ~ coredns_deploy_host_dns_port)
              | default([])
            )
            | unique
          }}
        coredns_deploy_health_listener_any: >-
          {{
            (coredns_deploy_health_listener.stdout
             | regex_search('(^|\\s)(\\*|0\\.0\\.0\\.0|\\[::\\]):' ~ coredns_deploy_host_health_port))
            is not none
          }}
        coredns_deploy_dns_listener_any: >-
          {{
            (
              (coredns_deploy_dns_listener_tcp.stdout | default(''))
              | regex_search('(^|\\s)(\\*|0\\.0\\.0\\.0|\\[::\\]):' ~ coredns_deploy_host_dns_port)
            ) is not none
            or
            (
              (coredns_deploy_dns_listener_udp.stdout | default(''))
              | regex_search('(^|\\s)(\\*|0\\.0\\.0\\.0|\\[::\\]):' ~ coredns_deploy_host_dns_port)
            ) is not none
          }}
      changed_when: false

    - name: Determine CoreDNS restart need
      ansible.builtin.set_fact:
        coredns_deploy_force_restart: >-
          {{
            (not (coredns_deploy_health_ok_pre | default(false) | bool))
            and (
              (
                (coredns_deploy_health_listener_ips | length == 0)
                and not (coredns_deploy_health_listener_any | default(false))
              )
              or (
                (coredns_deploy_dns_listener_ips | length == 0)
                and not (coredns_deploy_dns_listener_any | default(false))
              )
              or (
                (coredns_deploy_host_ip not in coredns_deploy_health_listener_ips)
                and not (coredns_deploy_health_listener_any | default(false))
              )
              or (
                (coredns_deploy_host_ip not in coredns_deploy_dns_listener_ips)
                and not (coredns_deploy_dns_listener_any | default(false))
              )
            )
          }}
      changed_when: false

    - name: Enable and start Podman kube systemd unit
      ansible.builtin.systemd:
        name: "podman-kube@{{ coredns_deploy_systemd_name.stdout }}.service"
        enabled: true
        state: >-
          {{
            'restarted'
            if (
              (coredns_deploy_pod_manifest is defined and coredns_deploy_pod_manifest.changed)
              or (coredns_deploy_corefile is defined and coredns_deploy_corefile.changed)
              or (coredns_deploy_force_restart | default(false))
            )
            else 'started'
          }}
        daemon_reload: >-
          {{
            (coredns_deploy_systemd_dropin is defined and coredns_deploy_systemd_dropin.changed)
            or (coredns_deploy_pod_manifest is defined and coredns_deploy_pod_manifest.changed)
          }}

    - name: Wait until CoreDNS health endpoint is reachable
      ansible.builtin.uri:
        url: "{{ coredns_deploy_health_url_effective }}"
        method: GET
        validate_certs: "{{ coredns_deploy_validate_certs }}"
      register: coredns_deploy_health
      until: coredns_deploy_health.status == 200
      retries: 30
      delay: 5
      changed_when: false
      failed_when: coredns_deploy_health is failed or coredns_deploy_health.status != 200

    - name: Record CoreDNS health status
      ansible.builtin.set_fact:
        coredns_deploy_health_status: "{{ coredns_deploy_health.status | default(0) | int }}"
        coredns_deploy_health_ok: "{{ (coredns_deploy_health.status | default(0) | int) == 200 }}"
      changed_when: false
