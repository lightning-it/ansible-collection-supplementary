---
- name: Resolve MinIO root credentials (vars/env)
  ansible.builtin.set_fact:
    minio_deploy_root_user_effective: >-
      {{
        minio_deploy_root_user
          | default(lookup('env', 'MINIO_ROOT_USER') | default('', true), true)
      }}
    minio_deploy_root_password_effective: >-
      {{
        minio_deploy_root_password
          | default(lookup('env', 'MINIO_ROOT_PASSWORD') | default('', true), true)
      }}
  no_log: true
  changed_when: false

- name: Record MinIO credential source (provided)
  ansible.builtin.set_fact:
    minio_deploy_root_credentials_source: "provided"
  when:
    - minio_deploy_root_user_effective | default('') | length > 0
    - minio_deploy_root_password_effective | default('') | length > 0
  no_log: true
  changed_when: false

- name: Determine Vault auth availability for MinIO credentials
  ansible.builtin.set_fact:
    minio_deploy_vault_auth_token: "{{ minio_deploy_vault_token | default('', true) | trim }}"
    minio_deploy_vault_auth_role_id: "{{ minio_deploy_vault_role_id | default('', true) | trim }}"
    minio_deploy_vault_auth_secret_id: "{{ minio_deploy_vault_secret_id | default('', true) | trim }}"
    minio_deploy_vault_use_token: >-
      {{ (minio_deploy_vault_token | default('', true) | trim) | length > 0 }}
    minio_deploy_vault_auth_ok: >-
      {{
        ((minio_deploy_vault_token | default('', true) | trim) | length > 0)
        or
        (
          ((minio_deploy_vault_role_id | default('', true) | trim) | length > 0)
          and ((minio_deploy_vault_secret_id | default('', true) | trim) | length > 0)
        )
      }}
  changed_when: false

- name: Read MinIO root credentials from Vault (if allowed)
  community.hashi_vault.vault_kv2_get:
    url: "{{ minio_deploy_vault_address }}"
    validate_certs: "{{ minio_deploy_vault_validate_certs }}"
    engine_mount_point: "{{ minio_deploy_vault_kv_mount }}"
    path: "{{ minio_deploy_vault_kv_path }}"
    token: >-
      {{
        (minio_deploy_vault_auth_token | default(omit, true))
        if (minio_deploy_vault_use_token | bool)
        else omit
      }}
    role_id: >-
      {{
        (minio_deploy_vault_auth_role_id | default(omit, true))
        if not (minio_deploy_vault_use_token | bool)
        else omit
      }}
    secret_id: >-
      {{
        (minio_deploy_vault_auth_secret_id | default(omit, true))
        if not (minio_deploy_vault_use_token | bool)
        else omit
      }}
  register: minio_deploy_vault_root_read
  failed_when: false
  no_log: true
  when:
    - minio_deploy_vault_address | default('') | length > 0
    - minio_deploy_vault_auth_ok | bool
    - minio_deploy_vault_read_before_generate | default(true) | bool
      or minio_deploy_store_root_credentials | default(true) | bool
      or (minio_deploy_root_user_effective | default('') | length == 0)
      or (minio_deploy_root_password_effective | default('') | length == 0)

- name: Parse MinIO root credentials from Vault (if found)
  ansible.builtin.set_fact:
    minio_deploy_vault_root_user: >-
      {{ minio_deploy_vault_root_read.data.data.root_user | default('') }}
    minio_deploy_vault_root_password: >-
      {{ minio_deploy_vault_root_read.data.data.root_password | default('') }}
    minio_deploy_vault_root_present: >-
      {{
        (minio_deploy_vault_root_read.data.data.root_user | default('') | length > 0)
        and
        (minio_deploy_vault_root_read.data.data.root_password | default('') | length > 0)
      }}
  when:
    - minio_deploy_vault_root_read is defined
    - minio_deploy_vault_root_read.data is defined
    - minio_deploy_vault_root_read.data.data is defined
  no_log: true
  changed_when: false

- name: Use Vault MinIO root credentials when missing
  ansible.builtin.set_fact:
    minio_deploy_root_user_effective: "{{ minio_deploy_vault_root_user }}"
    minio_deploy_root_password_effective: "{{ minio_deploy_vault_root_password }}"
    minio_deploy_root_credentials_source: "vault"
  when:
    - minio_deploy_vault_root_present | default(false) | bool
    - minio_deploy_root_user_effective | default('') | length == 0
      or minio_deploy_root_password_effective | default('') | length == 0
  no_log: true
  changed_when: false

- name: Fail when MinIO root credentials are missing and Vault is not available
  ansible.builtin.fail:
    msg: >-
      MinIO root credentials are missing and Vault access is unavailable.
      Provide minio_deploy_root_user/minio_deploy_root_password or configure Vault
      access (minio_deploy_vault_address + token/approle).
  when:
    - minio_deploy_generate_root_credentials | default(true) | bool
    - minio_deploy_store_root_credentials | default(true) | bool
    - minio_deploy_root_user_effective | default('') | length == 0
      or minio_deploy_root_password_effective | default('') | length == 0
    - minio_deploy_vault_address | default('') | length == 0
      or not (minio_deploy_vault_auth_ok | bool)

- name: Generate MinIO root credentials when missing
  ansible.builtin.set_fact:
    minio_deploy_root_user_effective: >-
      {{
        minio_deploy_root_user_effective
          if (minio_deploy_root_user_effective | default('') | length > 0)
          else
          (
            minio_deploy_generated_root_user_prefix
            ~ '-'
            ~ lookup(
              'password',
              '/dev/null',
              length=minio_deploy_generated_root_user_length,
              chars='ascii_lowercase,digits'
            )
          )
      }}
    minio_deploy_root_password_effective: >-
      {{
        minio_deploy_root_password_effective
          if (minio_deploy_root_password_effective | default('') | length > 0)
          else
          lookup(
            'password',
            '/dev/null',
            length=minio_deploy_generated_root_password_length,
            chars='ascii_letters,digits'
          )
      }}
    minio_deploy_root_credentials_source: >-
      {{ minio_deploy_root_credentials_source | default('generated') }}
  when:
    - minio_deploy_generate_root_credentials | default(true) | bool
    - minio_deploy_root_user_effective | default('') | length == 0
      or minio_deploy_root_password_effective | default('') | length == 0
  no_log: true
  changed_when: false

- name: Store MinIO root credentials in Vault KV2 (if missing)
  community.hashi_vault.vault_kv2_write:
    url: "{{ minio_deploy_vault_address }}"
    validate_certs: "{{ minio_deploy_vault_validate_certs }}"
    engine_mount_point: "{{ minio_deploy_vault_kv_mount }}"
    path: "{{ minio_deploy_vault_kv_path }}"
    token: >-
      {{
        (minio_deploy_vault_auth_token | default(omit, true))
        if (minio_deploy_vault_use_token | bool)
        else omit
      }}
    role_id: >-
      {{
        (minio_deploy_vault_auth_role_id | default(omit, true))
        if not (minio_deploy_vault_use_token | bool)
        else omit
      }}
    secret_id: >-
      {{
        (minio_deploy_vault_auth_secret_id | default(omit, true))
        if not (minio_deploy_vault_use_token | bool)
        else omit
      }}
    data:
      root_user: "{{ minio_deploy_root_user_effective }}"
      root_password: "{{ minio_deploy_root_password_effective }}"
      source: "{{ minio_deploy_root_credentials_source | default('') }}"
      updated_at: "{{ ansible_date_time.iso8601 }}"
  register: minio_deploy_vault_root_write
  failed_when: not ansible_check_mode and (minio_deploy_vault_root_write is failed)
  when:
    - minio_deploy_store_root_credentials | default(true) | bool
    - minio_deploy_vault_address | default('') | length > 0
    - minio_deploy_vault_auth_ok | bool
    - minio_deploy_root_user_effective | default('') | length > 0
    - minio_deploy_root_password_effective | default('') | length > 0
    - not (minio_deploy_vault_root_present | default(false) | bool)
  no_log: true
