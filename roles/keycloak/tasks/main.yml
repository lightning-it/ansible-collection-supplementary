---
- name: Validate required variables for keycloak_platform_terraform
  ansible.builtin.assert:
    that:
      - keycloak_realms is defined
      - keycloak_realms | length > 0
      - keycloak_url is not none
      - keycloak_client_id is not none
      - keycloak_client_secret is not none
      - keycloak_master_realm is not none
    fail_msg: >
      Required variables are missing for keycloak_platform_terraform. Please set
      keycloak_realms, keycloak_url, keycloak_client_id, keycloak_client_secret
      and keycloak_master_realm.
    success_msg: >
      All required variables for keycloak_platform_terraform are set.

- name: Check if terraform is available on the control host
  ansible.builtin.command: terraform version
  register: tf_version
  changed_when: false
  failed_when: tf_version.rc != 0

- name: Ensure Terraform working directory exists
  ansible.builtin.file:
    path: "{{ keycloak_tf_workdir }}"
    state: directory
    mode: "0755"

- name: Render Terraform main.tf for keycloak_platform module
  ansible.builtin.template:
    src: "main.tf.j2"
    dest: "{{ keycloak_tf_workdir }}/main.tf"
    mode: "0644"

- name: Initialize Terraform in working directory
  ansible.builtin.command:
    cmd: terraform init -input=false
    chdir: "{{ keycloak_tf_workdir }}"
  register: tf_init
  changed_when: >
    'Terraform has been successfully initialized!' in tf_init.stdout or
    'Initializing the backend...' in tf_init.stdout

- name: Apply Terraform configuration for keycloak_platform
  ansible.builtin.command:
    cmd: terraform apply -auto-approve -input=false
    chdir: "{{ keycloak_tf_workdir }}"
  register: tf_apply
  changed_when: "'No changes.' not in tf_apply.stdout"

- name: Show Terraform apply output
  ansible.builtin.debug:
    var: tf_apply.stdout_lines
