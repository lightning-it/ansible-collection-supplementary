---
- name: Ensure required Vault config vars are defined
  ansible.builtin.include_tasks: assert_config.yml
  tags: always

- name: Check Vault seal status
  ansible.builtin.uri:
    url: "{{ vault_config_api_url }}/v1/sys/seal-status"
    method: GET
    validate_certs: "{{ vault_config_vault_validate_certs }}"
  register: vault_config_seal_status
  changed_when: false
  failed_when: vault_config_seal_status.status not in [200]
  tags:
    - config
    - api

- name: Fail when Vault is sealed
  ansible.builtin.fail:
    msg: "Vault is sealed; run vault_bootstrap or unseal manually before configuring."
  when: vault_config_seal_status.json.sealed | default(true)
  tags:
    - config

- name: Map vault_init to vault_config_init when provided
  ansible.builtin.set_fact:
    vault_config_init: "{{ vault_init }}"
  when:
    - vault_config_init is not defined
    - vault_init is defined
  no_log: true
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Map vault_config_init root token when provided
  ansible.builtin.set_fact:
    vault_config_token: "{{ vault_config_init.root_token | default('', true) | trim }}"
  no_log: true
  when:
    - vault_config_token | default('', true) | trim | length == 0
    - vault_config_init is defined
    - vault_config_init.root_token | default('', true) | trim | length > 0
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Map vault_token to vault_config_token
  ansible.builtin.set_fact:
    vault_config_token: >-
      {{
        (vault_config_token | default('', true) | trim)
        if (vault_config_token | default('', true) | trim | length > 0)
        else (vault_token | default('', true) | trim)
      }}
  no_log: true
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Ensure Vault token is available
  ansible.builtin.assert:
    that:
      - vault_config_token | default('', true) | trim | length > 0
    fail_msg: "vault_config_token is required to configure Vault (or provide vault_config_init.root_token)."
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Normalize AppRole secrets for terragrunt
  ansible.builtin.set_fact:
    vault_config_approle_secrets_render: "{{ (vault_config_approle_secrets_render | default([])) + [_entry] }}"
  vars:
    _token_policy: "{{ vault_config_approle_item.token_policy | default(vault_config_approle_policy_name, true) }}"
    _entry: >-
      {{
        vault_config_approle_item
        | combine({
            'token_policy': (
              _token_policy
              if (_token_policy is sequence and _token_policy is not string)
              else [_token_policy]
            )
          }, recursive=True)
      }}
  loop: "{{ vault_config_approle_secrets | default([], true) }}"
  loop_control:
    loop_var: vault_config_approle_item
  when: vault_config_approle_secrets | default([], true) | length > 0
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Normalize Vault PKI server fields for terragrunt
  ansible.builtin.set_fact:
    vault_config_vault_pki_roots: "{{ _vault_pki_roots }}"
    vault_config_vault_pki_intermediates: "{{ _vault_pki_intermediates }}"
    vault_config_pki_roots: "{{ _vault_pki_roots_compat }}"
    vault_config_pki_intermediates: "{{ _vault_pki_intermediates_compat }}"
  vars:
    _default_server: >-
      {{
        (vault_config_url | default('', true) | trim)
        if (vault_config_url | default('', true) | trim | length > 0)
        else (vault_config_vault_address | default('', true) | trim)
      }}
    _vault_pki_roots: >-
      {%- set roots = [] -%}
      {%- for item in vault_config_vault_pki_roots | default([], true) -%}
      {%- set server = item.vault_config_server
          | default(item.vault_server | default(_default_server, true), true) -%}
      {%- set _ = roots.append(item | combine({'vault_config_server': server}, recursive=True)) -%}
      {%- endfor -%}
      {{ roots }}
    _vault_pki_intermediates: >-
      {%- set intermediates = [] -%}
      {%- for item in vault_config_vault_pki_intermediates | default([], true) -%}
      {%- set server = item.vault_config_server
          | default(item.vault_server | default(_default_server, true), true) -%}
      {%- set _ = intermediates.append(item | combine({'vault_config_server': server}, recursive=True)) -%}
      {%- endfor -%}
      {{ intermediates }}
    _vault_pki_roots_compat: >-
      {%- set roots = [] -%}
      {%- for item in _vault_pki_roots -%}
      {%- set server = item.vault_server
          | default(item.vault_config_server | default(_default_server, true), true) -%}
      {%- set _ = roots.append(item | combine({'vault_server': server}, recursive=True)) -%}
      {%- endfor -%}
      {{ roots }}
    _vault_pki_intermediates_compat: >-
      {%- set intermediates = [] -%}
      {%- for item in _vault_pki_intermediates -%}
      {%- set server = item.vault_server
          | default(item.vault_config_server | default(_default_server, true), true) -%}
      {%- set _ = intermediates.append(item | combine({'vault_server': server}, recursive=True)) -%}
      {%- endfor -%}
      {{ intermediates }}
  when:
    - (vault_config_vault_pki_roots | default([], true) | length > 0)
      or (vault_config_vault_pki_intermediates | default([], true) | length > 0)
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Ensure local terragrunt state directory exists
  ansible.builtin.file:
    path: "{{ vault_config_terraform_state_dir_local }}"
    state: directory
    mode: '0700'
  delegate_to: localhost
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Ensure Vault bootstrap state directory exists on target
  ansible.builtin.file:
    path: "{{ vault_config_terraform_state_dir }}"
    state: directory
    mode: '0700'
    owner: root
    group: root
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Find existing Vault bootstrap tfstate files on target
  ansible.builtin.find:
    paths: "{{ vault_config_terraform_state_dir }}"
    patterns:
      - "*.tfstate"
      - "*.tfstate.backup"
      - "*.tfstate.*"
    recurse: false
    file_type: file
  register: vault_config_tfstate_files_remote
  changed_when: false
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Find existing Vault bootstrap tfstate files on controller
  ansible.builtin.find:
    paths: "{{ vault_config_terraform_state_dir_local }}"
    patterns:
      - "*.tfstate"
      - "*.tfstate.backup"
      - "*.tfstate.*"
    recurse: false
    file_type: file
  register: vault_config_tfstate_files_local
  changed_when: false
  delegate_to: localhost
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Copy target tfstate files to controller when local is empty
  ansible.builtin.fetch:
    src: "{{ vault_config_tfstate_file.path }}"
    dest: "{{ vault_config_terraform_state_dir_local }}/"
    flat: true
  loop: "{{ vault_config_tfstate_files_remote.files }}"
  loop_control:
    loop_var: vault_config_tfstate_file
  when:
    - vault_config_tfstate_files_remote.matched | int > 0
    - vault_config_tfstate_files_local.matched | int == 0
  no_log: true
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Set Vault terragrunt template path
  ansible.builtin.set_fact:
    vault_config_terragrunt_template_path: "{{ role_path }}/templates/vault.hcl.j2"
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Run terragrunt to configure Vault
  vars:  # noqa var-naming[no-role-prefix]
    terragrunt_template: "{{ vault_config_terragrunt_template_path }}"
    terragrunt_vault_token: "{{ vault_config_token }}"
    terragrunt_vault_addr: "{{ vault_config_vault_address }}"
    terragrunt_delegate_to: localhost
  ansible.builtin.include_role:
    name: lit.foundational.terragrunt
  no_log: true
  tags:
    - config
    - terragrunt_validate
    - terragrunt_plan
    - terragrunt_apply

- name: Find local Vault bootstrap tfstate files
  ansible.builtin.find:
    paths: "{{ vault_config_terraform_state_dir_local }}"
    patterns:
      - "*.tfstate"
      - "*.tfstate.backup"
      - "*.tfstate.*"
    recurse: false
    file_type: file
  register: vault_config_tfstate_files
  changed_when: false
  delegate_to: localhost
  tags:
    - config
    - terragrunt_apply
    - tfstate
    - tfstate_migrate

- name: Copy local Vault bootstrap tfstate files to target
  ansible.builtin.copy:
    src: "{{ vault_config_tfstate_file.path }}"
    dest: "{{ vault_config_terraform_state_dir }}/{{ vault_config_tfstate_file.path | basename }}"
    owner: root
    group: root
    mode: "0600"
  loop: "{{ vault_config_tfstate_files.files }}"
  loop_control:
    loop_var: vault_config_tfstate_file
  when: vault_config_tfstate_files.matched | int > 0
  tags:
    - config
    - terragrunt_apply
    - tfstate
    - tfstate_migrate

- name: Migrate Vault bootstrap tfstate when backend is ready
  when:
    - vault_config_tfstate_files.matched | int > 0
    - tfstate_backend_ready | default(false) | bool
    - tfstate_s3_endpoint | default('', true) | length > 0
    - tfstate_bucket | default('', true) | length > 0
    - tfstate_access_key | default('', true) | length > 0
    - tfstate_secret_key | default('', true) | length > 0
  tags:
    - config
    - terragrunt_apply
    - tfstate
    - tfstate_migrate
  block:
    - name: Migrate Vault bootstrap tfstate to S3 backend
      ansible.builtin.include_role:
        name: lit.foundational.terraform_state_migrate
        apply:
          delegate_to: localhost
      vars:
        terraform_state_migrate_local_root: "{{ vault_config_terraform_state_dir_local }}"
        terraform_state_migrate_s3_endpoint: "{{ tfstate_s3_endpoint }}"
        terraform_state_migrate_s3_bucket: "{{ tfstate_bucket }}"
        terraform_state_migrate_s3_access_key: "{{ tfstate_access_key }}"
        terraform_state_migrate_s3_secret_key: "{{ tfstate_secret_key }}"
        terraform_state_migrate_s3_region: "{{ tfstate_region | default('', true) }}"
        terraform_state_migrate_s3_key_prefix: "{{ tfstate_key_prefix | default('', true) }}"
      no_log: true
      tags:
        - tfstate
        - tfstate_migrate

    - name: Remove Vault bootstrap local tfstate files after migration
      ansible.builtin.file:
        path: "{{ vault_config_tfstate_file.path }}"
        state: absent
      loop: "{{ vault_config_tfstate_files.files }}"
      loop_control:
        loop_var: vault_config_tfstate_file
      delegate_to: localhost
      tags:
        - tfstate
        - tfstate_migrate
  rescue:
    - name: Record Vault bootstrap tfstate after failed migration
      ansible.builtin.set_fact:
        tfstate_pending_dirs: >-
          {{
            (tfstate_pending_dirs | default([]))
            | union([vault_config_terraform_state_dir_local])
          }}
      tags:
        - tfstate
        - tfstate_migrate

- name: Record Vault bootstrap tfstate for later migration
  ansible.builtin.set_fact:
    tfstate_pending_dirs: >-
      {{
        (tfstate_pending_dirs | default([]))
        | union([vault_config_terraform_state_dir_local])
      }}
  when:
    - vault_config_tfstate_files.matched | int > 0
    - not (
        (tfstate_backend_ready | default(false) | bool)
        and (tfstate_s3_endpoint | default('', true) | length > 0)
        and (tfstate_bucket | default('', true) | length > 0)
        and (tfstate_access_key | default('', true) | length > 0)
        and (tfstate_secret_key | default('', true) | length > 0)
      )
  tags:
    - config
    - terragrunt_apply
    - tfstate
    - tfstate_migrate

- name: Bootstrap AppRole credentials
  ansible.builtin.include_tasks: bootstrap_approle.yml
  when:
    - vault_config_hashi_vault_auth_method == 'approle'
    - vault_config_approle_bootstrap | bool
  tags:
    - vault_config_pki

- name: Request Vault PKI certificate
  ansible.builtin.include_tasks: vault_pki.yml
  when: vault_config_pki_enabled | bool
  tags:
    - vault_config_pki
