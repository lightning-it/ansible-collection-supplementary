---
name: Publish collection to Galaxy

on:
  release:
    types: [published]

jobs:
  publish_galaxy:
    name: Publish collection to Ansible Galaxy
    runs-on: ubuntu-latest
    environment:
      name: ansible-collections
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ansible-core
        run: |
          python -m pip install --upgrade pip
          python -m pip install "ansible-core==2.15.13"

      - name: Build collection
        run: ansible-galaxy collection build

      - name: Publish collection to Ansible Galaxy
        env:
          ANSIBLE_GALAXY_API_KEY: ${{ secrets.ANSIBLE_GALAXY_API_KEY }}
        run: |
          tarball=$(ls lit-supplementary-*.tar.gz)
          ansible-galaxy collection publish "$tarball" \
            --api-key "$ANSIBLE_GALAXY_API_KEY"
