---
repos:
  - repo: local
    hooks:
      # yamllint via wunder-devtools-ee container
      - id: yamllint-ee
        name: yamllint (wunder-devtools-ee)
        language: system
        entry: bash scripts/wunder-devtools-ee.sh yamllint
        pass_filenames: true
        files: \.(yml|yaml)$

      # ansible-lint im wunder-devtools-ee container
      - id: ansible-lint-ee
        name: ansible-lint (wunder-devtools-ee)
        language: system
        entry: bash
        args:
          - "-c"
          - |
            set -e
            bash scripts/wunder-devtools-ee.sh bash -c '
              set -e
              rm -rf /tmp/wunder/.cache/ansible-compat \
                /tmp/wunder/collections \
                /tmp/wunder/lightning_it-*.tar.gz
              ansible-galaxy collection build \
                --output-path /tmp/wunder \
                --force
              ansible-galaxy collection install \
                /tmp/wunder/lightning_it-supplementary-*.tar.gz \
                -p /tmp/wunder/collections \
                --force
              cd /tmp/wunder/collections/ansible_collections
              cd lightning_it/supplementary
              export ANSIBLE_CONFIG=$PWD/ansible.cfg
              export ANSIBLE_COLLECTIONS_PATHS=/tmp/wunder/collections
              export ANSIBLE_LINT_OFFLINE=true
              export ANSIBLE_LINT_SKIP_GALAXY_INSTALL=1
              ansible-lint
            '
          - "--"
        pass_filenames: false
        files: \.(yml|yaml)$

      # molecule scenario for keycloak-local (via wunder-devtools-ee)
      - id: molecule-keycloak-local
        name: molecule test (keycloak-local)
        language: system
        entry: bash
        args:
          - "-c"
          - |
            set -e
            bash scripts/wunder-devtools-ee.sh bash -c '
              set -e
              rm -rf /tmp/wunder/.cache/ansible-compat \
                /tmp/wunder/collections \
                /tmp/wunder/lightning_it-*.tar.gz
              ansible-galaxy collection build \
                --output-path /tmp/wunder \
                --force
              ansible-galaxy collection install \
                /tmp/wunder/lightning_it-supplementary-*.tar.gz \
                -p /tmp/wunder/collections \
                --force
              export ANSIBLE_CONFIG=/workspace/ansible.cfg
              export ANSIBLE_COLLECTIONS_PATHS=/tmp/wunder/collections
              molecule test -s keycloak-local
            '
          - "--"
        pass_filenames: false
      - id: molecule-rhel9-rdp
        name: molecule rhel9-rdp (Vagrant)
        language: system
        stages: [manual]
        entry: bash
        args:
          - "-c"
          - |
            set -euo pipefail

            # 1) VM start
            pushd vagrant/rhel9 >/dev/null
            vagrant up
            popd >/dev/null

            # 2) Molecule (container)
            ANSIBLE_COLLECTIONS_PATHS="$PWD" \
            ANSIBLE_ROLES_PATH="$PWD/roles" \
            bash scripts/wunder-devtools-ee.sh \
              molecule test -s rhel9-rdp

            # 3) VM destory
            pushd vagrant/rhel9 >/dev/null
            vagrant destroy -f
            popd >/dev/null
          - "--"
        pass_filenames: false
